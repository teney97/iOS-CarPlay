## iOS CarPlayï½œè®©ä½ çš„éŸ³é¢‘ App æ”¯æŒ CarPlay

ä» iOS 14 å¼€å§‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ CarPlay framework æ¥å¼€å‘éŸ³é¢‘ CarPlay Appï¼ˆå¦‚æœæ˜¯å¯¼èˆªç±» Appï¼Œåœ¨ iOS 12 å°±å¯ä»¥ä½¿ç”¨ï¼‰ï¼Œå®ƒæä¾›äº†ä¸€äº› UI æ¨¡ç‰ˆæ¥æ”¯æŒå¼€å‘è€…è‡ªå®šä¹‰ç•Œé¢ï¼›å¦‚æœä½ è¦å…¼å®¹ iOS 13 åŠæ›´æ—©ç‰ˆæœ¬çš„è¯éœ€è¦ä½¿ç”¨ MediaPlayer framework å¼€å‘ï¼Œå®ƒå‘å‰å…¼å®¹ã€‚å› æ­¤ï¼Œå¦‚æœä½ çš„ App éœ€è¦åœ¨ iOS 14 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šä½¿ç”¨ CarPlay frameworkï¼Œå¹¶ä¸”å…¼å®¹ iOS 13 åŠæ›´æ—©ç‰ˆæœ¬çš„è¯ï¼Œå°±è¦ç»´æŠ¤ä¸¤å¥—ä»£ç ï¼Œå¼€å‘å·¥ä½œé‡å¯èƒ½æ¥è¿‘ doubleã€‚ç¬”è€…ä»…æ”¯æŒäº† iOS 14 åŠæ›´é«˜ç‰ˆæœ¬ï¼Œåœ¨æœ¬ç« èŠ‚ä¸­ä¼šè¯¦ç»†è®²è§£ä½¿ç”¨ CarPlay framework çš„å¼€å‘ç»†èŠ‚ã€‚å¦‚æœä½ æƒ³æ”¯æŒä½ç‰ˆæœ¬çš„è¯ä¹Ÿå¯ä»¥çœ‹çœ‹ç¬”è€…å¯¹ã€ŒWWDC17 - è®©æ‚¨çš„ App æ”¯æŒ CarPlay è½¦è½½ã€å’Œã€ŒWWDC18 - CarPlay è½¦è½½éŸ³é¢‘å’Œå¯¼èˆª Appã€åšçš„ç¬”è®°ã€‚

### ç”³è¯·æƒé™å¹¶é…ç½®å·¥ç¨‹

é¦–å…ˆï¼Œéœ€è¦ç¡®å®šä½ çš„ App æ˜¯å¦é€‚ç”¨äº CarPlayï¼Œç„¶åå»å¼€å‘è€…ç½‘ç«™ç”³è¯·å¯¹åº” App ç±»å‹çš„ CarPlay æƒé™ï¼Œå¹¶å¯¹å·¥ç¨‹è¿›è¡Œé…ç½®ã€‚åªæœ‰è¿™æ ·ä½ çš„å·¥ç¨‹æ‰èƒ½ä½¿ç”¨ CarPlay Simulatorï¼Œå¦åˆ™ä½ çš„ CarPlay Simulator æ— æ³•æ‰“å¼€ï¼ˆç°æ˜¾ç¦ç”¨ï¼‰ã€‚ä¸è¿‡ç¬”è€…æ³¨æ„åˆ°ï¼Œåªè¦ä½ çš„ CarPlay Simulator å¯ç”¨è¿‡ï¼Œå³ä¾¿æ˜¯ä¸æ”¯æŒ CarPlay çš„ App ä¹Ÿæ˜¯å¯ä»¥æ‰“å¼€ CarPlay Simulator çš„ã€‚å› æ­¤ä½ å¯ä»¥è·‘ä¸€é Apple çš„ CarPlay ç¤ºä¾‹ App [CarPlay Music App](https://developer.apple.com/documentation/carplay/integrating_carplay_with_your_music_app?language=objc) æ¥å¯ç”¨ CarPlay Simulatorã€‚

ä¸è¿‡ï¼Œè¦ä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯•ä½ çš„ CarPlay Appï¼Œè¿˜æ˜¯å¾—ä½ è‡ªå·±çš„å·¥ç¨‹æ”¯æŒæ‰è¡Œã€‚

å› æ­¤ï¼Œå¦‚æœä½ è®¡åˆ’è¦å¼€å‘ CarPlay App çš„è¯ï¼Œæœ€å¥½æå‰å»ç”³è¯·æƒé™ï¼Œå› ä¸º Apple å®¡æ ¸è¿˜è¦æ—¶é—´ã€‚åœ¨æ­¤æœŸé—´å¯ä»¥çœ‹çœ‹ç›¸å…³å¼€å‘æ–‡æ¡£ï¼Œç­‰æƒé™ç”³è¯·ä¸‹æ¥å¹¶é…ç½®å¥½å·¥ç¨‹å°±å¯ä»¥ä½¿ç”¨ CarPlay Simulator è°ƒè¯•å¼€å‘å•¦ã€‚

å‚è€ƒæ–‡æ¡£ï¼š[ç”³è¯· CarPlay æƒé™](https://developer.apple.com/documentation/carplay/requesting_the_carplay_entitlements?language=objc)

### ä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯• CarPlay App

æ¯ä¸ª iPhone Simulator éƒ½é™„å¸¦ä¸€ä¸ª CarPlay Simulatorï¼Œåœ¨ **I/O > External Displays > CarPlay** æ‰“å¼€ã€‚é»˜è®¤çš„æ ‡å‡†çš„ CarPlay Simulator çª—å£å¤§å°å’Œæ¯”ä¾‹ä¸º `800 x 480, @2x`ã€‚

å¦‚æœæ˜¯å¯¼èˆªç±» Appï¼ŒApple å»ºè®®å¼€å¯ CarPlay Simulator çš„é™„åŠ é€‰é¡¹ï¼Œåœ¨ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤ã€‚è¿™å…è®¸ä½ æ¯æ¬¡å¯åŠ¨ CarPlay Simulator å‰éƒ½å¯ä»¥è®¾ç½®çª—å£å¤§å°å’Œæ¯”ä¾‹ï¼Œç”¨æ¥æµ‹è¯•ç¡®ä¿ä½ çš„åœ°å›¾å†…å®¹é€‚é…äº†æ‰€æœ‰æ¨èçš„é…ç½®ã€‚ä¹Ÿè®¸åªæ”¯æŒå¯¼èˆªç±» App å§ï¼ŒéŸ³é¢‘ç±» App æ”¹å˜çª—å£å¤§å°åæ˜¾ç¤ºæ•ˆæœä¸å°½å¦‚äººæ„ï¼Œå»ºè®®å…³é—­ã€‚

```
defaults write com.apple.iphonesimulator CarPlayExtraOptions -bool YES
```

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d693e45a0ca4c1598fa3b71e5706e45~tplv-k3u1fbpfcp-watermark.image?)

å¦‚æœä½ æ‰“å¼€äº† CarPlay Simulator å´æ²¡æœ‰åœ¨ä¸»å±å¹•ä¸Šçœ‹åˆ°ä½ çš„ Appï¼Œé‚£ä¹ˆä½ å¯èƒ½æ˜¯å¿˜äº†æ·»åŠ å¯¹åº”çš„æƒåˆ©ã€‚ä½ éœ€è¦å°† Key `com.apple.developer.carplay-audio` æ·»åŠ åˆ° Entitlements.plist ä¸­å¹¶è®¾ç½® Value ä¸º 1ã€‚

```xml
<key>com.apple.developer.carplay-audio</key>
<true/>
```

å‚è€ƒæ–‡æ¡£ï¼š[ä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯• CarPlay App](https://developer.apple.com/documentation/carplay/using_the_carplay_simulator?language=objc)

å¦‚æœä½ æ˜¯ M1 Macï¼Œé‚£å¯èƒ½æ— æ³•ä½¿ç”¨ CarPlay Simulatorã€‚å¦‚æœä½ çš„ Xcode ä»¥ Rosetta æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆå¯åŠ¨ CarPlay App ä¼šç›´æ¥ crashã€‚å°† Simulator ä¹Ÿä»¥ Rosetta è¿è¡Œå¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜æš‚æ—¶æ²¡æœ‰è§£å†³æ–¹æ¡ˆã€‚https://issueexplorer.com/issue/mapbox/mapbox-navigation-ios/3355ã€‚

### å£°æ˜ä¸€ä¸ª CarPlay scene

åœ¨ Info.plist ä¸­å£°æ˜ä¸€ä¸ª sceneã€‚

```xml
<key>UIApplicationSceneManifest</key>
<dict>
    <key>UIApplicationSupportsMultipleScenes</key>
		<false/>
		<key>UISceneConfigurations</key>
		<dict>
			<key>CPTemplateApplicationSceneSessionRoleApplication</key>
			<array>
			    <dict>
			        <key>UISceneClassName</key>
			        <string>CPTemplateApplicationScene</string>
			        <key>UISceneConfigurationName</key>
			        <string>CarPlaySceneConfiguration</string>
			        <key>UISceneDelegateClassName</key>
			        <string>$(PRODUCT_MODULE_NAME).CarPlaySceneDelegate</string>
			    </dict>
			</array>
    </dict>
</dict>
```

### å®ç° CarPlaySceneDelegate

```swift
import CarPlay

class CarPlaySceneDelegate: UIResponder, CPTemplateApplicationSceneDelegate {
    var interfaceController: CPInterfaceController?

    func templateApplicationScene(_ templateApplicationScene: CPTemplateApplicationScene,
            didConnect interfaceController: CPInterfaceController) {

        self.interfaceController = interfaceController
        let item = CPListItem(text: "Rubber Soul", detailText: "The Beatles")
        let section = CPListSection(items: [item])
        let listTemplate = CPListTemplate(title: "Albums", sections: [section])
        interfaceController.setRootTemplate(listTemplate, animated: true)
    }

    func templateApplicationScene(_ templateApplicationScene: CPTemplateApplicationScene,
            didDisconnect interfaceController: CPInterfaceController) {
        self.interfaceController = nil
    }
}
```

CPTemplateApplicationSceneDelegate åè®®å®šä¹‰äº† CarPlay åœ¨åœºæ™¯è¿æ¥ã€æ–­å¼€è¿æ¥ã€ä»¥åŠå“åº”æŸäº›ç”¨æˆ·æ“ä½œçš„æ–¹æ³•ã€‚ä½ éœ€è¦åœ¨ CarPlay å¯åŠ¨ä½ çš„ App å¹¶è¿æ¥å…¶åœºæ™¯æ—¶åˆ›å»ºå’Œè®¾ç½®æ ¹æ¨¡æ¿ã€‚ä¸€èˆ¬æˆ‘ä»¬å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š

* [- templateApplicationScene:didConnectInterfaceController:](https://developer.apple.com/documentation/carplay/cptemplateapplicationscenedelegate/3578119-templateapplicationscene?language=objc)

  é€šçŸ¥ä»£ç† CarPlay Scene å·²è¿æ¥ã€‚å½“ App åœ¨è½¦æœºå±å¹•ä¸Šå¯åŠ¨æ—¶ï¼ŒCarPlay framework å°†è°ƒç”¨æ­¤æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¯¹æ¨¡æ¿è¿›è¡Œåˆå§‹åŒ–ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºäº† [CPInterfaceController](https://developer.apple.com/documentation/carplay/cpinterfacecontroller/) å®ä¾‹ï¼ˆç±»ä¼¼ UINavigationControllerï¼‰ï¼Œä½œä¸ºæˆ‘ä»¬ CarPlay App çš„å…¥å£ controllerï¼Œæˆ‘ä»¬åªéœ€åœ¨å›è°ƒä¸­æŒæœ‰è¿™ä¸ªå®ä¾‹å³å¯ã€‚åœ¨ä»¥ä¸Šç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨æ¨¡æ¿ CPListTemplateï¼ˆç±»ä¼¼ UITableViewï¼‰ï¼Œå…¶æ¥æ”¶å¤šç»„ CPListSectionï¼Œsection ä¸­åŒ…å«å¤šä¸ª CPListItemï¼ˆç±»ä¼¼ UITableViewCellï¼‰ã€‚æœ€åï¼Œæˆ‘ä»¬å°† CPListTemplate è®¾ç½®ä¸º App çš„æ ¹æ¨¡æ¿ï¼ˆç±»ä¼¼ rootViewControllerï¼‰ã€‚

* [- templateApplicationScene:didDisconnectInterfaceController:](https://developer.apple.com/documentation/carplay/cptemplateapplicationscenedelegate/3578120-templateapplicationscene?language=objc)

  é€šçŸ¥ä»£ç† CarPlay Scene å·²æ–­å¼€è¿æ¥ã€‚å½“è½¦æœºæ–­å¼€è¿æ¥æ—¶ï¼Œè¯¥æ–¹æ³•å°†è¢«è°ƒç”¨ï¼Œå¯ä»¥åšä¸€äº›æ¸…ç†å·¥ä½œã€‚

å‚è€ƒæ–‡æ¡£ï¼š[åœ¨ä½ çš„ CarPlay App ä¸­æ˜¾ç¤ºå†…å®¹](https://developer.apple.com/documentation/carplay/displaying_content_in_carplay?language=objc)

### CarPlay ç•Œé¢æ­å»º

CarPlay App ç•Œé¢åŸºæœ¬å°±æ˜¯ç”± Template å’Œ Item ç»„æˆï¼Œè€ŒéŸ³é¢‘ç±»çš„ CarPlay App åŸºæœ¬ä¸Šä½¿ç”¨ CPTabBarTemplateã€CPListTemplateã€CPListImageRowItemã€CPListItem ç­‰ç­‰å³å¯å®Œæˆç•Œé¢çš„æ­å»ºã€‚

| Templates                                                    | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [CPListTemplate](https://developer.apple.com/documentation/carplay/cplisttemplate?language=objc)<br />- [CPListItem](https://developer.apple.com/documentation/carplay/cplistitem?language=objc)<br />- [CPListImageRowItem](https://developer.apple.com/documentation/carplay/cplistimagerowitem?language=objc)<br />- [CPMessageListItem](https://developer.apple.com/documentation/carplay/cpmessagelistitem?language=objc) | åˆ—è¡¨æ¨¡ç‰ˆï¼ˆç±»ä¼¼ UITableViewï¼‰<br />- ä¸€ä¸ªé€šç”¨çš„ã€å¯é€‰æ‹©çš„åˆ—è¡¨é¡¹ï¼ˆå¯¹åº”ä¸‹å›¾ç¬¬ 2 ä¸ªï¼‰<br />- æ˜¾ç¤ºä¸€ç³»åˆ—å›¾åƒçš„åˆ—è¡¨é¡¹ï¼ˆå¯¹åº”ä¸‹å›¾ç¬¬ 3 ä¸ªï¼‰<br />- è¡¨ç¤ºå¯¹è¯æˆ–è”ç³»äººçš„åˆ—è¡¨é¡¹ï¼ˆç”¨äºé€šä¿¡ç±» Appï¼‰ï¼ˆå¯¹åº”ä¸‹å›¾ç¬¬ 1 ä¸ªï¼‰ |
| [CPGridTemplate](https://developer.apple.com/documentation/carplay/cpgridtemplate?language=objc) | æ˜¾ç¤ºå’Œç®¡ç† items ç½‘æ ¼çš„æ¨¡ç‰ˆ                                  |
| [CPTabBarTemplate](https://developer.apple.com/documentation/carplay/cptabbartemplate?language=objc) | TabBar æ¨¡ç‰ˆï¼ˆç±»ä¼¼ UITabBarControllerï¼‰                       |

![](https://docs-assets.developer.apple.com/published/49959584ba/rendered2x-1619630673.png)

#### CPTabBarTemplate

TabBar æ¨¡ç‰ˆï¼Œç±»ä¼¼ UIKit ä¸­çš„ UITabBarControllerã€‚ä½¿ç”¨ä¸€ç»„ CPTemplate è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯ä»¥å°†å…¶ä½œä¸º interfaceController çš„ rootTemplateã€‚

```swift
let tabBarTemplate = CPTabBarTemplate(templates: templates)
interfaceController.setRootTemplate(tabBarTemplate, animated: true)
```

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90920a58c3264fb98908516fffb09449~tplv-k3u1fbpfcp-watermark.image?)

éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼ŒCPTabBarTemplate çš„ templates æ˜¯æœ‰ä¸ªæ•°é™åˆ¶çš„ï¼Œæœ€å¤§æ•°é‡é€šè¿‡ [maximumTabCount](https://developer.apple.com/documentation/carplay/cptabbartemplate/3589351-maximumtabcount/) ç±»å±æ€§è·å–ï¼Œå®ƒçš„å€¼å–å†³äºåœ¨ Entitlements.plist ä¸­æ·»åŠ çš„æƒåˆ©ï¼ŒéŸ³é¢‘ App æœ€å¤šæ·»åŠ  4 ä¸ªï¼Œè¶…è¿‡æ•°é‡ä¼š crashã€‚

> åœ¨ [WWDC17 - è®©ä½ çš„ App æ”¯æŒ CarPlay è½¦è½½](https://github.com/teney97/iOS-CarPlay/blob/main/Content/WWDC17%20-%20%E8%AE%A9%E6%82%A8%E7%9A%84%20App%20%E6%94%AF%E6%8C%81%20CarPlay%20%E8%BD%A6%E8%BD%BD.md) ä¸­ Apple æåˆ°è¿‡ä½¿ç”¨ MediaPlayer framework æ¥æ„å»ºçš„ CarPlay App æ—¶ï¼Œæ¨èä½¿ç”¨æœ€å¤š 4 ä¸ª tabs å¹¶ä¸”ä½¿ç”¨è¾ƒçŸ­çš„æ ‡é¢˜ï¼Œå› ä¸ºç©ºé—´æœ‰é™å¹¶ä¸”æœ‰äº›æ±½è½¦çš„å±å¹•æ¯”è¾ƒçª„ï¼Œè€Œä¸”æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾çš„æ—¶å€™è¿˜éœ€åœ¨ rootTemplate å³ä¸Šè§’æ˜¾ç¤º â€œæ­£åœ¨æ’­æ”¾â€ æŒ‰é’®ã€‚

```swift
/**
 The maximum number of tabs that your app may display in a @c CPTabBarTemplate,
 depending on the entitlements that your app declares.

 @warning The system will throw an exception if your app attempts to display more
 than this number of tabs in your tab bar template.
 */
open class var maximumTabCount: Int { get }
```

å¯ä»¥è®¾ç½®æ¯ä¸ª template çš„ tab çš„ tabTitle å’Œ tabImageï¼Œä¹Ÿå¯ä»¥è®¾ç½® tabSystemItem ç”¨ç³»ç»Ÿæ ·å¼ï¼ˆå¯ç”¨æ ·å¼è¾ƒå°‘ï¼Œä¸”æ²¡åŠæ³•è‡ªå®šä¹‰æ–‡æ¡ˆï¼‰ã€‚å¦‚æœä½ æ²¡æœ‰è®¾ç½® tabSystemItem å¹¶ä¸” tabImage ä¸º nil çš„è¯ï¼Œé‚£ä¹ˆè¯¥ tabBarItem å°†ä¼šä½¿ç”¨ UITabBarItem.SystemItem.moreã€‚

```swift
// è‡ªå®šä¹‰ tab æ ·å¼
listTemplate.tabTitle = "æ¨è"
listTemplate.tabImage = UIImage(named: "tabbar_recommend")
// ä½¿ç”¨ç³»ç»Ÿ tab æ ·å¼ï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† tabTitle å’Œ tabImageï¼Œé‚£ä¹ˆ tabSystemItem å°†ä¸ç”Ÿæ•ˆ
listTemplate.tabSystemItem = .favorites
// æ˜¾ç¤ºçº¢ç‚¹
listTemplate.showsTabBadge = true
```

è¿™æ—¶å€™å°±è¦æ‰¾ UI å‡ºå›¾äº†ï¼Œå‚è€ƒæ–‡æ¡£ï¼š[CarPlay UI è®¾è®¡æŒ‡å—](https://developer.apple.com/design/human-interface-guidelines/carplay/icons-and-images/custom-icons/)ã€‚

CPTabBarTemplate æœ‰ä¸ªéµå¾ª [CPTabBarTemplateDelegate](https://developer.apple.com/documentation/carplay/cptabbartemplatedelegate/) åè®®çš„ delegate å±æ€§ï¼ŒCPTabBarTemplateDelegate å°±ä¸€ä¸ªæ–¹æ³•ï¼š

```swift
public protocol CPTabBarTemplateDelegate : NSObjectProtocol {
    func tabBarTemplate(_ tabBarTemplate: CPTabBarTemplate, didSelect selectedTemplate: CPTemplate)
}
```

ä½ å¯ä»¥åœ¨è¯¥æ–¹æ³•ä¸­åˆ·æ–° selectedTemplate æ•°æ®ï¼Œå¦‚æœéœ€è¦çš„è¯ã€‚

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œä¸ UITabBarController çš„ `- tabBarController:didSelectViewController:` ä¸åŒçš„æ˜¯ï¼š

* åœ¨ CPTabBarTemplate å‘ˆç°å¹¶é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª tab æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥ä»£ç†æ–¹æ³•ä¸€æ¬¡ï¼Œå› æ­¤ä½ éœ€è¦æ³¨æ„åœ¨è¯¥ä»£ç†æ–¹æ³•å®ç°ä¸­æ˜¯å¦éœ€è¦è¿‡æ»¤æ‰ç¬¬ä¸€æ¬¡è°ƒç”¨
* ç‚¹å‡»å½“å‰é€‰ä¸­çš„ tab ä¹Ÿä¼šè°ƒç”¨ä»£ç†æ–¹æ³•ï¼Œå› æ­¤ä½ ä¹Ÿéœ€è¦æ³¨æ„ä¸‹æ˜¯å¦è¿‡æ»¤è¿™ä¸€æƒ…å†µ

#### CPListTemplate

åˆ—è¡¨æ¨¡ç‰ˆï¼Œç±»ä¼¼ UITableviewã€‚å¯ä»¥ä½¿ç”¨ä¸€ç»„ CPListTemplate æ¥åˆå§‹åŒ– CPTabBarTemplateã€‚CPListTemplate ç”±éµå¾ª [CPListTemplateItem](https://developer.apple.com/documentation/carplay/cplisttemplateitem/) åè®®çš„ item ç»„æˆï¼Œitem ç±»ä¼¼ UITableviewCellã€‚ä¸€èˆ¬éŸ³é¢‘ App å°±ä½¿ç”¨ CPListItem å’Œ CPListImageRowItemã€‚

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c284c0486f8947dd82d8334b1b6c10b0~tplv-k3u1fbpfcp-watermark.image?)

CPListTemplate æœ‰ä¸ªéµå¾ª[CPListTemplateDelegate](https://developer.apple.com/documentation/carplay/cplisttemplatedelegate/) åè®®çš„ delegate å±æ€§ï¼ŒCPListTemplateDelegate å°±ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡» item æ—¶è§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯¥æ–¹æ³•å®ç°ä¸­ push å…¶å®ƒ Templateã€‚

```swift
protocol CPListTemplateDelegate : NSObjectProtocol {
    func listTemplate(_ listTemplate: CPListTemplate, didSelect item: CPListItem, completionHandler: @escaping () -> Void)
}
```

æ³¨æ„è¿™é‡Œæœ‰ä¸ª completionHandler å‚æ•°ã€‚å½“ `- listTemplate:didSelectListItem:completionHandler:` æ–¹æ³•è¢«è°ƒç”¨ï¼Œåœ¨ completionHandler è°ƒç”¨ä¹‹å‰ï¼ŒdidSelectListItem ä¸Šä¼šåœ¨å³è¾¹æ˜¾ç¤ºä¸€ä¸ª loading æ´»åŠ¨æŒ‡ç¤ºå™¨ã€‚æœ€ä½³å®è·µæ˜¯ï¼Œåœ¨è¦æ’­æ”¾çš„å†…å®¹å·²ç»å‡†å¤‡å¥½ï¼Œæˆ–è€…é¡µé¢è·³è½¬å®Œæˆæ—¶ï¼ˆ`- pushTemplate:animated:completion:` çš„ completion ä¸­ï¼‰è°ƒç”¨ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿè¦ä¿è¯ completionHandler è¢«è°ƒç”¨ï¼Œæ¯”å¦‚æå‰é€€å‡ºæ—¶ï¼Œå¦åˆ™æ´»åŠ¨æŒ‡ç¤ºå™¨ä¼šä¸€ç›´å­˜åœ¨ã€‚

#### CPListImageRowItem

å¯ä»¥ç”¨æ¥å±•ç¤ºç”±ä¸€ç»„ä¸“è¾‘ç»„æˆçš„æ¨¡å—ã€‚ä½¿ç”¨æ–‡æœ¬å’Œä¸€ç»„å›¾ç‰‡åˆå§‹åŒ–ï¼Œæ–‡æœ¬å¯ä»¥å±•ç¤ºæ¨¡å—åç§°ï¼Œå›¾ç‰‡å¯ä»¥å±•ç¤ºæ¨¡å—é‡Œå‰ n ä¸ªä¸“è¾‘çš„å°é¢ã€‚

```swift
// éµå¾ªåè®®ï¼šCPListImageRowItem: CPSelectableListItem: CPListTemplateItem
let imagesCount = CPMaximumNumberOfGridImages // å–å†³äºæ±½è½¦æ˜¾ç¤ºå±çš„å¯ç”¨å®½åº¦
let images = Array(repeating: image, count: imagesCount)
let listImageRowItem = CPListImageRowItem(text: text, images: images)
```

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c4ef7bb3d374843b3daf25ae649fb4f~tplv-k3u1fbpfcp-watermark.image?)

CPListImageRowItem çš„ç‚¹å‡»åŒºåŸŸå¯ä»¥åˆ†ä¸ºæ¯å¼ å›¾ç‰‡åŒºåŸŸã€å›¾ç‰‡ä»¥å¤–çš„æ‰€æœ‰åŒºåŸŸã€‚

æ¯å¼ å›¾ç‰‡çš„ç‚¹å‡»å›è°ƒé€šè¿‡è®¾ç½® CPListImageRowItem å®ä¾‹çš„ listImageRowHandler å±æ€§æ¥ç›‘å¬ã€‚ç‚¹å‡»å¯ä»¥ push åˆ°è¯¥ä¸“è¾‘çš„éŸ³é¢‘åˆ—è¡¨é¡µé¢ã€‚

```swift
var listImageRowHandler: ((CPListImageRowItem, Int, @escaping () -> Void) -> Void)? // The image row item that the user selected.
```

å›¾ç‰‡ä»¥å¤–çš„åŒºåŸŸçš„ç‚¹å‡»å›è°ƒèµ°çš„æ˜¯ CPListTemplateDelegate çš„æ–¹æ³•ã€‚ç‚¹å‡»å¯ä»¥ push åˆ°è¯¥æ¨¡å—çš„ä¸“è¾‘åˆ—è¡¨é¡µé¢ã€‚

```swift
protocol CPListTemplateDelegate : NSObjectProtocol {
    func listTemplate(_ listTemplate: CPListTemplate, didSelect item: CPListItem, completionHandler: @escaping () -> Void)
}
```

#### CPListItem

å¯ä»¥ç”¨æ¥å±•ç¤ºä¸“è¾‘æˆ–éŸ³é¢‘ï¼Œæˆ–è€…å…¶å®ƒçš„ item å¦‚ â€œæ­£åœ¨åŠ è½½ä¸­â€ã€â€œè¿˜æ²¡æœ‰æ’­æ”¾è®°å½•â€ã€â€æ’­æ”¾å…¨éƒ¨â€œ ç­‰ç­‰ã€‚

å¯¹äºéŸ³é¢‘ itemï¼Œä¸€èˆ¬ç”±éŸ³é¢‘å°é¢ã€éŸ³é¢‘åç§°ã€éŸ³é¢‘æè¿°ç»„æˆï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ„é€ å™¨åˆå§‹åŒ– CPListItemã€‚

```swift
let listItem = CPListItem(text: audioName, 
                          detailText: audioDesc, 
                          image: audioCover)
```

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/125d842edab74a5d97cddbe2edbd2357~tplv-k3u1fbpfcp-watermark.image?)

å¯¹äºä¸“è¾‘ itemï¼Œè¿˜éœ€è¦å³è¾¹çš„å¯¼èˆªç®­å¤´æ¥å’ŒéŸ³é¢‘ item åšåŒºåˆ†ï¼ŒæŒ‡ç¤ºç”¨æˆ·ç‚¹å‡»å¯ä»¥æ‰“å¼€éŸ³é¢‘åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ„é€ å™¨åˆå§‹åŒ– CPListItemã€‚

```swift
let listItem = CPListItem(text: albumName, 
                          detailText: albumDesc, 
                          image: albumCover, 
                          accessoryImage: nil, 
                          accessoryType: .disclosureIndicator)
```

å³è¾¹çš„å›¾æ ‡æœ‰ä¸¤ä¸ªç³»ç»Ÿæ ·å¼ï¼ˆç®­å¤´ã€äº‘æœµï¼‰ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒè‡ªå®šä¹‰ã€‚

```swift
enum CPListItemAccessoryType : Int {
    case none = 0
    case disclosureIndicator = 1
    case cloud = 2
}
```

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d384991a82f4deba5f3fe53d9fc2f56~tplv-k3u1fbpfcp-watermark.image?)

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœ CPListItem çš„ detailText ä¸º nil çš„è¯ï¼Œview é«˜åº¦ä¼šå‡å°ï¼Œå¹¶å°† text å±…ä¸­æ˜¾ç¤ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™ä¼šå½±å“ç¾è§‚ä»¥åŠæ•´ä½“ç»Ÿä¸€æ€§ã€‚å› æ­¤ï¼Œä½ å¯ä»¥è€ƒè™‘å½“éŸ³é¢‘æ²¡æœ‰å‰¯æ ‡é¢˜æ—¶ï¼Œä½¿ç”¨éŸ³é¢‘æ—¶é•¿æˆ–å…¶å®ƒæ•°æ®å¡«å…… detailTextã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0aaab77e2bc146649b32fe54b06b4c2b~tplv-k3u1fbpfcp-watermark.image?)

#### CPNowPlayingTemplate

éŸ³é¢‘æ’­æ”¾é¡µæ˜¯éŸ³é¢‘ç±» CarPlay App æœ€é‡è¦çš„é¡µé¢äº†ï¼Œä½¿ç”¨ [CPNowPlayingTemplate](https://developer.apple.com/documentation/carplay/cpnowplayingtemplate/)ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¾‹ã€‚

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95c7eb8bdac4467396a7c9dce25a11a8~tplv-k3u1fbpfcp-watermark.image?)

ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é…ç½® CPNowPlayingTemplateï¼Œæ¯”å¦‚æ·»åŠ æ§åˆ¶æŒ‰é’®ã€‚ä½ å¯ä»¥ä½¿ç”¨ CarPlay framework æä¾›çš„ä¸€äº›ç³»ç»ŸæŒ‰é’®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æŒ‰é’®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ è¦åœ¨ `- templateApplicationScene:didConnectInterfaceController:` çš„æ—¶æœºå°±é…ç½®å¥½ CPNowPlayingTemplateï¼Œè€Œä¸åº”è¯¥åœ¨ push åˆ° CPNowPlayingTemplate çš„æ—¶å€™æ‰å»é…ç½®ï¼Œå› ä¸º CPNowPlayingTemplate å¹¶ä¸ä¸€å®šæ˜¯é€šè¿‡ä¸»åŠ¨ push æ—¶è§¦å‘ï¼Œè¿˜å¯èƒ½æ˜¯é€šè¿‡ â€œæ’­æ”¾ä¸­â€ App æˆ–è€… rootTemplate å³ä¸Šè§’çš„ â€œæ­£åœ¨æ’­æ”¾æŒ‰é’®â€ã€‚

```swift
let nowPlayingTemplate = CPNowPlayingTemplate.shared
let repeatButton = CPNowPlayingRepeatButton() { ... }
let playbackRateButton = CPNowPlayingPlaybackRateButton() { ... }
nowPlayingTemplate.updateNowPlayingButtons([repeatButton, playbackRateButton])
```

æ— è®ºä½ æ˜¯ä½¿ç”¨ CarPlay framework è¿˜æ˜¯ MediaPlayer framework æ¥æ„å»ºçš„ CarPlay Appï¼Œéƒ½æ˜¯é€šè¿‡ [MPNowPlayingInfoCenter](https://developer.apple.com/documentation/mediaplayer/mpnowplayinginfocenter/) å’Œ [MPRemoteCommandCenter](https://developer.apple.com/documentation/mediaplayer/mpremotecommandcenter/) æ¥æä¾›æ’­æ”¾ç•Œé¢çš„éŸ³é¢‘ä¿¡æ¯ä»¥åŠå“åº”è¿œç¨‹æ’­æ”¾æ§åˆ¶äº‹ä»¶ã€‚åªä¸è¿‡åœ¨ CarPlay framework ä¸­ï¼Œä¸€äº›è¿œç¨‹æ§åˆ¶äº‹ä»¶é€šè¿‡ [CPNowPlayingButton](https://developer.apple.com/documentation/carplay/cpnowplayingbutton/) çš„ handler æ¥å¤„ç†äº†ï¼Œæ¯”å¦‚æ’­æ”¾æ¨¡å¼ã€æ’­æ”¾é€Ÿç‡ç­‰ç­‰ã€‚å½“ç„¶å¦‚æœä½ çš„ App æ˜¯éŸ³é¢‘ç±»çš„è¯ï¼Œåº”è¯¥å·²ç»æ”¯æŒäº†è¿™äº›åŠŸèƒ½ï¼Œå› ä¸º iPhone é”å±ç•Œé¢ä»¥åŠæ§åˆ¶ä¸­å¿ƒçš„éŸ³é¢‘æ’­æ”¾ä¿¡æ¯å’Œæ’­æ”¾æ§åˆ¶ä¹Ÿæ˜¯é€šè¿‡å®ƒä»¬æä¾›ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹ CarPlay åšä¸‹ä¼˜åŒ–æˆ–è€…åŠŸèƒ½å¢å¼ºå°±è¡Œã€‚æˆ‘ä»¬å…·ä½“è¦åšçš„æ˜¯ï¼š

* è®¾ç½®å’Œæ›´æ–° MPNowPlayingInfoCenter çš„ [nowPlayingInfo](https://developer.apple.com/documentation/mediaplayer/mpnowplayinginfocenter/1615903-nowplayinginfo)ï¼Œå®ƒåŒ…å«å½“å‰æ’­æ”¾éŸ³é¢‘çš„å…ƒæ•°æ®ï¼Œå¦‚æ ‡é¢˜ã€ä½œè€…ã€æ—¶é•¿ç­‰ç­‰ã€‚æ—¶æœºï¼š

  * åˆ‡æ¢éŸ³é¢‘ï¼ˆä¸Šä¸€é¦–ã€ä¸‹ä¸€é¦–ç­‰ç­‰ï¼‰
  * æš‚åœã€æ¢å¤ã€åœæ­¢æ’­æ”¾
  * seekï¼ˆè·³è¿‡ç‰‡å¤´ã€æ‹–åŠ¨è¿›åº¦ç­‰ç­‰ï¼‰
  * æ›´æ–°æ’­æ”¾é€Ÿåº¦ï¼ˆCPNowPlayingTemplate ä¸­æ’­æ”¾é€Ÿåº¦æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰ã€‚å¦‚æœå½“å‰éŸ³é¢‘ä¸åœ¨æ’­æ”¾çŠ¶æ€ï¼Œéœ€å°†æ’­æ”¾é€Ÿåº¦è®¾ç½®ä¸º 0
  * ...

```swift
import MediaPlayer
// Set Metadata to be Displayed in Now Playing Info Center
let infoCenter = MPNowPlayingInfoCenter.default()
infoCenter.nowPlayingInfo = [MPMediaItemPropertyTitle: "Style",
                             MPMediaItemPropertyArtist: "Taylor Swift",
                             MPMediaItemPropertyAlbumTitle: "1989",
                             MPMediaItemPropertyGenre: "Pop",
                             MPMediaItemPropertyReleaseDate: "2014",
                             MPMediaItemPropertyPlaybackDuration: 231,
                             MPMediaItemPropertyArtwork: mediaItemArtwork,
                             MPNowPlayingInfoPropertyElapsedPlayback: 53,
                             MPNowPlayingInfoPropertyDefaultPlaybackRate: 1,
                             MPNowPlayingInfoPropertyPlaybackRate: 1,
                             MPNowPlayingInfoPropertyPlaybackQueueCount: 13,
                             MPNowPlayingInfoPropertyPlaybackQueueIndex: 3,
                            â€¦ ]
```

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¯¹äºæ’­æ”¾è¿›åº¦ä¹Ÿå°±æ˜¯å½“å‰éŸ³é¢‘å·²æ’­æ”¾æ—¶é•¿çš„æ›´æ–°ï¼Œç³»ç»Ÿä¼šæ ¹æ®å…ˆå‰æä¾›çš„**å·²æ’­æ”¾æ—¶é•¿**å’Œ**æ’­æ”¾é€Ÿåº¦**è‡ªåŠ¨æ¨æ–­å‡ºæ¥ã€‚å› æ­¤ä¸éœ€è¦ä¹Ÿä¸æ¨èé¢‘ç¹æ›´æ–° nowPlayingInfoï¼Œè¿™ä»£ä»·å¾ˆå¤§ã€‚

* é™¤äº† nowPlayingInfoï¼Œè¿˜æœ‰ä¸€äº›çŠ¶æ€éœ€è¦é€šè¿‡å…¶å®ƒæ–¹å¼åŒæ­¥åˆ° CarPlay Appï¼Œæ¯”å¦‚ï¼š

  * éŸ³é¢‘æ’­æ”¾çŠ¶æ€ï¼šæš‚åœ/æ’­æ”¾ï¼ˆCPNowPlayingTemplate ä¸­æ’­æ”¾æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰

  ```objectivec
  typedef NS_ENUM(NSUInteger, MPNowPlayingPlaybackState) {
      MPNowPlayingPlaybackStateUnknown = 0,
      MPNowPlayingPlaybackStatePlaying,
      MPNowPlayingPlaybackStatePaused,
      MPNowPlayingPlaybackStateStopped,
      MPNowPlayingPlaybackStateInterrupted
  };
  
  if (@available(iOS 13.0, *)) {
      MPNowPlayingInfoCenter.defaultCenter.playbackState = MPNowPlayingPlaybackStatePlaying; 
  }
  ```
  
  * æ’­æ”¾æ¨¡å¼çŠ¶æ€ï¼šé¡ºåºå¾ªç¯/å•æ›²å¾ªç¯ï¼ˆCPNowPlayingTemplate ä¸­æ’­æ”¾æ¨¡å¼æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰
  
  ```objectivec
  typedef NS_ENUM(NSInteger, MPRepeatType) {
      MPRepeatTypeOff,    /// Nothing is repeated during playback.
      MPRepeatTypeOne,    /// Repeat a single item indefinitely.
      MPRepeatTypeAll,    /// Repeat the current container or playlist indefinitely.
  };
  
  MPRemoteCommandCenter.sharedCommandCenter.changeRepeatModeCommand.currentRepeatType = MPRepeatTypeOne;
  ```

ä¸‹å›¾ä¸­çš„éŸ³é¢‘å°é¢ã€åç§°ã€æè¿°ã€æ—¶é•¿ã€å½“å‰æ’­æ”¾è¿›åº¦ã€æ’­æ”¾æ¨¡å¼ã€æ’­æ”¾é€Ÿåº¦ç­‰éŸ³é¢‘æ’­æ”¾ä¿¡æ¯ï¼Œéƒ½æ˜¯é€šè¿‡ä»¥ä¸Šæ–¹å¼åŒæ­¥æ˜¾ç¤ºåˆ° CPNowPlayingTemplate ä¸Šçš„ã€‚ä½ çš„éŸ³é¢‘ App ä¹‹å‰åº”è¯¥å·²ç»å®ç°äº†è¯¥åŠŸèƒ½ä»¥å°†éŸ³é¢‘æ’­æ”¾ä¿¡æ¯åŒæ­¥åˆ° iPhone é”å±ç•Œé¢ä»¥åŠæ§åˆ¶ä¸­å¿ƒï¼Œç°åœ¨åªéœ€è¦æ£€æŸ¥ä¸‹ CarPlay App çš„ CPNowPlayingTemplate ä¸­æ˜¾ç¤ºçš„éŸ³é¢‘æ’­æ”¾ä¿¡æ¯æ˜¯å¦å‡†ç¡®å³å¯ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e90b21bcb08844f28653fec9258721c3~tplv-k3u1fbpfcp-watermark.image?)

* å“åº” MPRemoteCommandCenter äº‹ä»¶ï¼Œå¯¹è¿œç¨‹æ’­æ”¾æ§åˆ¶äº‹ä»¶åšå‡ºå“åº”ï¼Œå¦‚æ’­æ”¾ã€æš‚åœã€åˆ‡æ¢æ­Œæ›²ç­‰ç­‰ã€‚

  * playCommand
  * pauseCommand
  * previousTrackCommand
  * nextTrackCommand
  * togglePlayPauseCommand
  * changeRepeatModeCommand
  * changePlaybackRateCommand
  * ...
* ä½¿ç”¨ CarPlay framework æ—¶ï¼ŒchangeRepeatModeCommandã€changePlaybackRateCommand ä¸å†ç”± MPRemoteCommandCenter è§¦å‘ï¼Œè€Œæ˜¯é€šè¿‡ [CPNowPlayingRepeatButton](https://developer.apple.com/documentation/carplay/cpnowplayingrepeatbutton/)ã€[CPNowPlayingPlaybackRateButton](https://developer.apple.com/documentation/carplay/cpnowplayingplaybackratebutton) çš„ handler å¤„ç†ï¼Œä½† command.enabled è¿˜æ˜¯è¦å¼€å¯ã€‚ä¾‹å¦‚ï¼š
  * å½“ command.enabled ä¸º true æ—¶ï¼Œç”¨æˆ·ç‚¹å‡»äº†æ’­æ”¾æ¨¡å¼æŒ‰é’®ï¼ŒCPNowPlayingRepeatButton çš„ handler å°±ä¼šè¢«è§¦å‘ï¼Œç„¶åä½ å¯ä»¥æ›´æ–° App æ’­æ”¾æ¨¡å¼ï¼Œå¹¶å°†æ’­æ”¾æ¨¡å¼çŠ¶æ€é€šè¿‡ä¸Šè¿°æ–¹å¼åŒæ­¥åˆ° CarPlayã€‚å¦‚æœä½ çš„ App è¿˜æ”¯æŒéšæœºæ’­æ”¾æ¨¡å¼ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª CPNowPlayingButtonï¼Œé…åˆ CPNowPlayingRepeatButton å®Œæˆ 3 ç§æ¨¡å¼çš„åˆ‡æ¢ã€‚
  * ç”±äºåªèƒ½å¾—çŸ¥ç”¨æˆ·ç‚¹å‡»äº†æŒ‰é’®ï¼Œè€Œä¸çŸ¥é“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„å…·ä½“æ„å›¾ï¼Œå› æ­¤ CPNowPlayingPlaybackRateButton handler çš„æœ€ä½³å®è·µæ˜¯ï¼Œè®¾å®šä¸€ä¸ªæ’­æ”¾é€Ÿåº¦èŒƒå›´ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æ—¶ï¼Œå¢åŠ  App æ’­æ”¾é€Ÿåº¦ï¼Œå¹¶é€šè¿‡æ›´æ–° nowPlayingInfo åŒæ­¥åˆ° CarPlayã€‚å¦‚æœå½“å‰éŸ³é¢‘æ­£åœ¨ä»¥æœ€å¿«çš„æ”¯æŒé€Ÿåº¦æ’­æ”¾ï¼Œé‚£ä¹ˆç»§ç»­å¢åŠ æ’­æ”¾é€Ÿåº¦å°±å°†å…¶è°ƒåˆ°æœ€å°é€Ÿåº¦ï¼Œä»¥æ­¤å¾ªç¯ã€‚

### æœ€ä½³å®è·µ

#### ä½¿ç”¨ userInfo å­˜å‚¨æ•°æ®

CPListItemã€CPListImageRowItem éƒ½æœ‰ä¸ª [userInfo](https://developer.apple.com/documentation/carplay/cplistitem/2977574-userinfo?language=objc) å±æ€§ï¼Œå®ƒç”¨æ¥å­˜å‚¨æ•°æ®ã€‚`CPListItem -> userInfo` å…³ç³»å°±ç±»ä¼¼äº `UITableViewCell -> model`ã€‚

```swift
// Use this property to attach a value that provides additional context to the list item. For example, you can attach a model object and reference it in the list itemâ€™s handler when processing the selection.
var userInfo: Any?
```

#### é€šè¿‡ isEnabled è®¾ç½® item çš„å¯äº¤äº’æ€§ï¼ˆiOS 15ï¼‰

CPListItemã€CPListImageRowItem éƒ½æœ‰ä¸ª [isEnabled](https://developer.apple.com/documentation/carplay/cplistitem/3751895-enabled?language=objc) å±æ€§ï¼Œå®ƒç”¨æ¥è®¾ç½® item çš„å¯äº¤äº’æ€§ï¼ˆé»˜è®¤å€¼ä¸º trueï¼‰ã€‚isEnabled è®¾ç½®ä¸º false çš„ item å°†ç°æ˜¾ä¸”ä¸å¯ç‚¹å‡»ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè§¦å‘ CPListTemplateDelegate çš„ `- listTemplate:didSelectListItem:completionHandler:` æ–¹æ³•ã€‚æœ€ä½³å®è·µæ˜¯ï¼Œå°† â€œè¿˜æ²¡æœ‰æ’­æ”¾è®°å½•â€ã€â€œæ­£åœ¨åŠ è½½ä¸­â€ è¿™äº›æœ¬èº«å°±æ²¡æœ‰äº¤äº’çš„ item çš„ isEnabled è®¾ç½®ä¸º falseï¼Œè¿™æ ·å‘ˆç°çš„ UI æ•ˆæœæ›´å¥½ï¼Œè€Œä¸”ä½ ä¹Ÿä¸ç”¨åœ¨ CPListTemplateDelegate çš„æ–¹æ³•ä¸­å¯¹è¿™äº› item åš guard å¤„ç†äº†ã€‚ä¸è¿‡è¯¥ API åœ¨ iOS 15 å¼€å§‹æ‰æ”¯æŒ ğŸ˜­ ï¼Œä½†æˆ‘ä»¬è¿˜æœ‰å…¶å®ƒæ–¹å¼å¯ä»¥é¿å…åœ¨ CPListTemplateDelegate çš„æ–¹æ³•ä¸­åš guard å¤„ç†ï¼Œé‚£å°±æ˜¯ç”¨ item çš„ handler å±æ€§ã€‚

```swift
// A Boolean value that indicates if the item is enabled.
@available(iOS 15.0, *)
var isEnabled: Bool
```

#### ä½¿ç”¨ handle å“åº” item çš„ç‚¹å‡»äº‹ä»¶

CPListItemã€CPListImageRowItem éƒ½æœ‰ä¸ª [handler](https://developer.apple.com/documentation/carplay/cplistitem/3667716-handler?language=objc) å±æ€§ï¼Œç”¨æ¥å“åº” item çš„ç‚¹å‡»äº‹ä»¶ã€‚å¦‚æœä½ ç»™ item è®¾ç½®äº† handlerï¼Œé‚£ä¹ˆç‚¹å‡» item å°†è§¦å‘ handler è€Œä¸è§¦å‘ CPListTemplateDelegate çš„æ–¹æ³•ã€‚

```swift
// An optional action block, fired when the user selects this item in a list template.
var handler: ((CPSelectableListItem, @escaping () -> Void) -> Void)?
```

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ handler æŠŠä¸€äº›ç‰¹æ®Š item çš„ç‚¹å‡»äº‹ä»¶å‰¥ç¦»å‡ºæ¥ï¼Œè€Œä¸æ˜¯å…¨éƒ¨æ”¾åˆ° CPListTemplateDelegate çš„ `- listTemplate:didSelectListItem:completionHandler:` ä¸­å¤„ç†ï¼Œè¿™æ ·å¯ä»¥**æé«˜ä»£ç å¯ç»´æŠ¤æ€§**ã€‚å¯¹äºä¸Šé¢è¯´çš„ isEnabled ä»…åœ¨ iOS 15 ä»¥ä¸Šæ‰æ”¯æŒçš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åƒä¸‹é¢è¿™æ ·å¤„ç†ï¼Œä»¥é¿å…åœ¨ CPListTemplateDelegate çš„æ–¹æ³•ä¸­åš guard å¤„ç†ã€‚

```swift
let item = CPListItem(text: "æ­£åœ¨åŠ è½½ä¸­", detailText: nil)
if #available(iOS 15.0, *) {
    item.isEnabled = false
} else {
    item.handler = { (item, completionHandler) in
        completionHandler()
    }
}
```

#### é€šè¿‡ isPlaying å±æ€§æ¥æ˜¾ç¤ºæ­£åœ¨æ’­æ”¾çš„æŒ‡ç¤ºå™¨

ä½¿ç”¨ CPListItem æ¥å±•ç¤ºéŸ³é¢‘ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡ [isPlaying](https://developer.apple.com/documentation/carplay/cplistitem/3551780-isplaying) å±æ€§æ¥æ˜¾ç¤ºæ­£åœ¨æ’­æ”¾çš„æŒ‡ç¤ºå™¨ã€‚

```swift
var isPlaying: Bool
```

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33d26d619a764d15a0449063b6c531b4~tplv-k3u1fbpfcp-watermark.image?)

æŒ‡ç¤ºå™¨çš„ä½ç½®é»˜è®¤åœ¨å·¦è¾¹ï¼Œéšè—äº† imageã€‚ä½ è¿˜å¯ä»¥é€šè¿‡ [playingIndicatorLocation](https://developer.apple.com/documentation/carplay/cplistitem/3566414-playingindicatorlocation?language=objc) å±æ€§è®¾ç½®æŒ‡ç¤ºå™¨ä½ç½®ä¸ºå³è¾¹ã€‚

```swift
enum CPListItemPlayingIndicatorLocation : Int {
    case leading = 0
    case trailing = 1
}

var playingIndicatorLocation: CPListItemPlayingIndicatorLocation
```

### é¡µé¢è·³è½¬

è¿˜è®°å¾—åœ¨ CarPlay App å…¥å£ [- templateApplicationScene:didConnectInterfaceController:](https://developer.apple.com/documentation/carplay/cptemplateapplicationscenedelegate/3578119-templateapplicationscene?language=objc) ä¸­çš„ [CPInterfaceController](https://developer.apple.com/documentation/carplay/cpinterfacecontroller/) å—ï¼Œå®ƒä½œä¸ºæˆ‘ä»¬ CarPlay App çš„å…¥å£ controllerï¼Œæˆ‘ä»¬å°†ä¸€ä¸ª template ä½œä¸º rootTemplate èµ‹å€¼ç»™å®ƒã€‚å½“æˆ‘ä»¬è¦è¿›è¡Œé¡µé¢è·³è½¬æ—¶ä¹Ÿæ˜¯é å®ƒï¼Œæœ‰ç‚¹ç±»ä¼¼äº UINavigationControllerï¼Œå®ƒæ”¯æŒ pushã€popã€presentã€dismiss ç­‰ç­‰æ“ä½œï¼ˆpresentã€dismiss æ“ä½œä»… CPActionSheetTemplateã€CPVoiceControlTemplateã€CPAlertTemplateï¼‰ã€‚å¯¹äºéŸ³é¢‘ Appï¼Œä¸€èˆ¬ push æ“ä½œå°±å¤Ÿç”¨ï¼Œå­é¡µé¢çš„å·¦ä¸Šè§’éƒ½è‡ªå¸¦è¿”å›æŒ‰é’®çš„ã€‚

### ä»£ç è®¾è®¡

å¯å‚è€ƒï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f1c43bf92714e8e8dde65bd14dc3089~tplv-k3u1fbpfcp-watermark.image?)

### å›¾ç‰‡

#### å›¾æ ‡å’Œå›¾ç‰‡

å¯ä»¥çœ‹çœ‹ [CarPlay - è®¾è®¡æŒ‡å—](https://developer.apple.com/design/human-interface-guidelines/carplay/overview/introduction/)ï¼Œå¹¶å°†å®ƒå‘ç»™ä½ çš„ PM å’Œ UIã€‚

#### æ·±è‰²/æµ…è‰²æ¨¡å¼

é€‚é…æ–¹æ¡ˆå’Œ iPhone App ä¸€æ ·ï¼Œå¦‚æœä½ çš„ App éœ€è¦ä¸¤ç§é£æ ¼çš„è¯å°±æ”¯æŒä¸€ä¸‹ã€‚

#### å¼‚æ­¥å›¾ç‰‡

* CarPlay ä¸æ”¯æŒ GIF å›¾ç‰‡ï¼Œé…ç½®ä¼šå¯¼è‡´ crashã€‚ç¬”è€…å°è¯•å–å‡º GIF å›¾çš„ç¬¬ä¸€å¸§ï¼Œå‘ç°è¿˜æ˜¯ä¸æ”¯æŒï¼Œæˆ–è®¸æ˜¯æˆ‘ä½¿ç”¨æ–¹å¼ä¸å¯¹ã€‚
* asyncImage ä¹Ÿéœ€è¦é€‚é…ä¸‹ scaleï¼Œå¦åˆ™ä¼šæ¨¡ç³Šã€‚
* å¯ä»¥å¯¹ CPListItem å’Œ CPListImageRowItem æ‰©å±•ä¸‹ asyncImage çš„æ–¹æ³•ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚

```swift
@available(iOS 14, *)
protocol CPAsyncImage {
    func loadImage(with url: URL?, complete: @escaping (UIImage?) -> (Void))
    static var placeholderImage: UIImage { get }
}

@available(iOS 14, *)
extension CPAsyncImage {
    
    func loadImage(with url: URL?, complete: @escaping (UIImage?) -> (Void)) {
        
        guard let url = url else {
            complete(nil)
            return
        }
        
        // è¿™å„¿ä¹Ÿå¯ä»¥æ ¹æ® urlType åšä¸‹è¿‡æ»¤
        
        SDWebImageManager.shared.loadImage(with: url, options: .retryFailed, progress: nil) { image, data, error, type, finished, imageURL in
            
            guard var image = image, image.images == nil else {
                complete(nil)
                return
            }
                   
            if let cgImage = image.cgImage {
                let screen = TTScene.carPlay?.value(forKey: "screen") as? UIScreen
                let scale = screen?.scale ?? 1
                image = UIImage(cgImage: cgImage, scale: scale, orientation: .up)
            }
            complete(image)
        }
    }
    
    static var placeholderImage: UIImage {
        UIImage(named: "CP_default") ?? UIImage()
    }
}

@available(iOS 14, *)
extension CPListItem: CPAsyncImage {
    
    func asyncImage(with url: URL?, placeholderImage: UIImage? = CPListItem.placeholderImage, complete: ((UIImage?) -> (Void))? = nil) {
        
        self.setImage(placeholderImage)
        loadImage(with: url) { [weak self] image in
            guard let image = image else { return }
            self?.setImage(image)
            complete?(image)
        }
    }
}

@available(iOS 14, *)
extension CPListImageRowItem: CPAsyncImage {
    
    func asyncImage(with urls: [URL?], placeholderImage: UIImage = CPListImageRowItem.placeholderImage, complete: (((index: Int, image: UIImage?)) -> (Void))? = nil) {
        
        var images = Array(repeating: placeholderImage, count: urls.count)
        self.update(images)
        
        for (index, url) in urls.enumerated() {
            loadImage(with: url) { [weak self] image in
                guard let image = image else { return }
                images[index] = image
                self?.update(images)
                complete?((index, image))
            }
        }
    }
}
```

### é‡æ–°åŠ è½½æ•°æ®

ç½‘ç»œä¸å¥½çš„æƒ…å†µä¸‹å¯åŠ¨ CarPlay Appï¼Œå¯èƒ½å°±ä¼šå­˜åœ¨è¯·æ±‚è¶…æ—¶ï¼ŒCarPlay App ä¸­æ— æ•°æ®ã€‚å¤„ç†æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. ä¸é‡æ–°åŠ è½½ã€‚å¦‚æœæ˜¯é¦–é¡µï¼Œåˆ™ç”¨æˆ·éœ€è¦é‡æ–°å¯åŠ¨ CarPlay App æ‰èƒ½é‡æ–°åŠ è½½ï¼›å¦‚æœæ˜¯å­é¡µé¢ï¼Œåˆ™ç”¨æˆ·éœ€è¦é€€å‡ºå¹¶é‡æ–°è¿›å…¥å­é¡µé¢æ‰èƒ½é‡æ–°åŠ è½½ã€‚çœ‹äº†ç½‘æ˜“äº‘ CarPlay App å°±æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œä¸è¿‡å®ƒçš„é¦–é¡µæœ‰å›ºå®šçš„å‡ ä¸ª itemï¼Œå€’æ˜¯ä¸å½±å“ä½“éªŒã€‚å¦‚æœä½ çš„é¦–é¡µå†…å®¹æ²¡æœ‰æœ¬åœ° itemï¼Œé‚£ä¸å»ºè®®ä»¥è¿™ç§æ–¹å¼å¤„ç†ï¼›
2. å¦‚æœ rootTemplate æ˜¯ CPTabBarTemplateï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨ `- tabBarTemplate:didSelectTemplate:` æ—¶æœºå¯¹ selectedTemplate è¿›è¡Œé‡æ–°åŠ è½½æ“ä½œï¼›
3. å¯¹äºç¬¬äºŒç§æ–¹å¼ï¼Œé‡æ–°åŠ è½½å¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºä½ æ²¡åŠæ³•æˆ–è€…ä¸æ–¹ä¾¿è‡ªå·±æ·»åŠ ä¸ªæ´»åŠ¨æŒ‡ç¤ºå™¨ã€‚æˆ‘çš„æ–¹æ¡ˆæ˜¯ï¼Œåœ¨è¯·æ±‚æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œæ·»åŠ ä¸ª loading itemï¼ˆæ¯”å¦‚ä½¿ç”¨ CPListItem å¹¶æ˜¾ç¤º â€œæ­£åœ¨åŠ è½½ä¸­â€ï¼‰ã€‚å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåˆ™æ›´æ–° item ä¸º failure itemï¼ˆæ¯”å¦‚ä½¿ç”¨ CPListItem å¹¶æ˜¾ç¤º â€œåŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•â€ï¼‰ã€‚å½“ç”¨æˆ·ç‚¹å‡» failure item æ—¶ï¼Œæ›´æ–° item ä¸º loading itemï¼Œå¹¶é‡æ–°è¯·æ±‚æ•°æ®ã€‚å¯¹äºæ¯ä¸ªéœ€è¦ä»æœåŠ¡ç«¯æ‹‰å–æ•°æ®çš„é¡µé¢éƒ½å¯ä»¥è¿™æ ·å¤„ç†ã€‚

æ˜¯å¦éœ€è¦åˆ·æ–°ï¼Ÿå¦‚æœæƒ³è¦å…è®¸ä½¿ç”¨ CarPlay App çš„è¿‡ç¨‹ä¸­å»åˆ·æ–°æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ç¬¬äºŒç§æ–¹å¼å¤„ç†ã€‚ä¸è¿‡ï¼Œç”¨æˆ·å•æ¬¡ä½¿ç”¨ CarPlay çš„æ—¶é—´ä¸ä¼šå¾ˆé•¿ï¼Œæ²¡æœ‰å¿…è¦åšåˆ·æ–°ï¼Œä¸‹æ¬¡å¯åŠ¨çš„æ—¶é—´æ‹‰å–æ–°æ•°æ®å°±å¥½ã€‚å› æ­¤ï¼Œæˆ‘åªé’ˆå¯¹é¦–æ¬¡æ•°æ®åŠ è½½å¤±è´¥çš„æƒ…å†µåšäº†é‡æ–°åŠ è½½å¤„ç†ã€‚

### å…³æ³¨å¼±ç½‘ä»¥åŠæ— ç½‘ç¯å¢ƒä¸‹çš„ç”¨æˆ·ä½“éªŒ

åœ¨ WWDC æˆ–ç›¸å…³æ–‡æ¡£ä¸­ï¼ŒApple å¤šæ¬¡æåˆ°è¦å…³æ³¨å¼±ç½‘ä»¥åŠæ— ç½‘ç¯å¢ƒä¸‹çš„ç”¨æˆ·ä½“éªŒï¼Œå› ä¸ºé©¾é©¶è¿‡ç¨‹ä¸­å¯èƒ½ä¼šç»è¿‡ç½‘ç»œä¸å¥½çš„è·¯æ®µæˆ–åŒºåŸŸã€‚ä¾‹å¦‚ä¸Šé¢æåˆ°çš„ â€è¯·æ±‚è¶…æ—¶ï¼Œé‡æ–°åŠ è½½æ•°æ®â€œ é—®é¢˜ã€CPNowPlayingTemplate ä¸­æ•°æ®åŒæ­¥ä»¥åŠæ’­æ”¾æ§åˆ¶äº‹ä»¶æ˜¯å¦å‡ºç°å¼‚å¸¸ç­‰ç­‰ã€‚

### åŸ‹ç‚¹

ä¸€äº›åŸ‹ç‚¹å¯èƒ½éœ€è¦é€šè¿‡æŠ•æœºå–å·§çš„æ–¹æ³•ã€‚æ¯”å¦‚åœ¨å“ªä¸ªé¡µé¢è§¦å‘äº†è¿”å›æŒ‰é’®ï¼Œå¯ä»¥é€šè¿‡ `- templateDidAppear`ã€`- templateWillDisappear` ç­‰æ–¹æ³•é…åˆå®ç°ã€‚emmm... åŠ äº†åŸ‹ç‚¹åä»£ç ä¸€ç‚¹å„¿ä¹Ÿä¸ç®€æ´äº†ã€‚

### æµ‹è¯•

åœ¨çœŸå®ç¯å¢ƒï¼ˆæ±½è½¦ä¸­ï¼‰æµ‹è¯•ã€‚[Appleï½œä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯• CarPlay App](https://developer.apple.com/documentation/carplay/using_the_carplay_simulator?language=objc) ä¸­åˆ—ä¸¾äº†ä¸€äº›åœ¨ CarPlay Simulator ä¸Šæ— æ³•æµ‹è¯•çš„åŠŸèƒ½ã€‚

å¯¹äºéŸ³é¢‘ Appï¼ŒSimulator åœ¨æ’­æ”¾çŠ¶æ€ä¸‹æœ‰ä¸€äº›å±€é™ï¼Œä¸èƒ½åæ˜ çœŸå®çš„ç”¨æˆ·ä½“éªŒã€‚

ä¸ºäº†ç”¨ LLDB å…¨é¢è°ƒè¯•ä½ çš„ Appï¼ŒXcode 9 å¼€å§‹æ”¯æŒæ— çº¿è°ƒè¯•ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ iPhone è¿æ¥æ±½è½¦çš„åŒæ—¶è°ƒè¯•ä½ çš„ Appã€‚å¯ä»¥è§‚çœ‹ [WWDC19 - ä½¿ç”¨ Xcode 9 è¿›è¡Œè°ƒè¯•](https://developer.apple.com/wwdc17/404) äº†è§£æ›´å¤šã€‚

## æ³¨æ„ç‚¹ & æœ€ä½³å®è·µ

* å•ä¾‹é—®é¢˜ã€‚CarPlay ç”¨åˆ°äº†å•ä¾‹ç±»ï¼ŒCarPlay App å…³é—­ï¼Œä½† iPhone App æ²¡å…³é—­ï¼Œè¿›ç¨‹æ˜¯è¿˜åœ¨çš„ï¼Œå•ä¾‹è¿˜æœªé‡Šæ”¾ï¼Œå¯èƒ½ä¼šé€ æˆä¸€äº›é—®é¢˜ã€‚å¯ä»¥åœ¨ `- templateApplicationScene:didConnectInterfaceController:` ä¸­åˆå§‹åŒ–å•ä¾‹ï¼Œåœ¨ `- templateApplicationScene:didDisconnectInterfaceController:` ä¸­é‡Šæ”¾å•ä¾‹ã€‚
* CarPlay çš„è¯­è¨€æ˜¯è·Ÿéš iPhone çš„ï¼ŒSimulator ä¹Ÿæ˜¯å¦‚æ­¤ã€‚
* CarPlay framework éœ€è¦è®¾ç½®ä¸ºå¼±å¼•ç”¨ optionalï¼ˆTarget > Build phases > Link Binary With Librariesï¼‰ï¼Œå¦åˆ™åœ¨ iOS 12 ä»¥ä¸‹å¯åŠ¨ App ä¼š crashã€‚
* CarPlay æ–­å¼€è¿æ¥æ—¶ï¼Œå»ºè®®æš‚åœéŸ³ä¹ã€‚
* CarPlay æ–­å¼€è¿æ¥æ—¶ï¼Œå¯ä»¥é€šè¿‡ Memory Graph æ£€æŸ¥ä¸‹æœ‰æ— å†…å­˜æ³„æ¼ã€‚
* Template é¡µé¢æœ€å¥½è‡³å°‘æ˜¾ç¤ºä¸€é¡¹å†…å®¹ï¼Œç‰¹åˆ«æ˜¯ä½ æ²¡æœ‰ä½¿ç”¨ CPTabBarTemplate ä½œä¸º rootTemplate çš„æƒ…å†µï¼Œå¦åˆ™é¡µé¢å°†ä¸€ç‰‡ç©ºç™½ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚ä¾‹å¦‚ï¼Œåœ¨æœ€è¿‘æ’­æ”¾é¡µé¢ï¼Œå½“æ²¡æœ‰æ’­æ”¾è®°å½•æ—¶ï¼Œå¡«å……ä¸€ä¸ª CPListItem å¹¶æ˜¾ç¤º â€œå½“å‰æ²¡æœ‰æ’­æ”¾è®°å½•â€ã€‚
* ä½ éœ€è¦æ³¨æ„ä¸€äº›æƒ…å†µï¼Œæ¯”å¦‚ iPhone é”å±ã€ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œä½ çš„ App ä»ç„¶éœ€è¦åœ¨ CarPlay ä¸­å±•ç¤ºå®Œç¾çš„åŠŸèƒ½æ€§ã€‚
