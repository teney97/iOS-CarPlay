## å¼€å‘ CarPlay éŸ³é¢‘ App

ä» iOS 14 å¼€å§‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ CarPlay framework æ¥å¼€å‘éŸ³é¢‘ CarPlay appï¼ˆå¦‚æœæ˜¯å¯¼èˆªç±» appï¼Œåœ¨ iOS 12 å°±å¯ä»¥ä½¿ç”¨ CarPlay Frameworkï¼‰ï¼Œå®ƒæä¾›äº†ä¸€äº› UI æ¨¡ç‰ˆæ¥æ”¯æŒå¼€å‘è€…è‡ªå®šä¹‰ç•Œé¢ï¼›å¦‚æœä½ è¦å…¼å®¹ iOS 13 åŠæ›´æ—©ç‰ˆæœ¬çš„è¯éœ€è¦ä½¿ç”¨ MediaPlayer framework å¼€å‘ï¼Œå®ƒå‘å‰å…¼å®¹ã€‚å¦‚æœä½ çš„ app éœ€è¦åœ¨ iOS 14 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šä½¿ç”¨ CarPlay frameworkï¼Œå¹¶ä¸”å…¼å®¹ iOS 13 çº§æ›´æ—©ç‰ˆæœ¬çš„è¯ï¼Œå°±è¦ç»´æŠ¤ä¸¤å¥—ä»£ç ï¼Œå¼€å‘å·¥ä½œé‡å¯èƒ½æ¥è¿‘ doubleã€‚ç¬”è€…ä»…æ”¯æŒäº† iOS 14 åŠæ›´é«˜ç‰ˆæœ¬ï¼Œå› æ­¤åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ä¼šè¯¦ç»†è®²è§£å¼€å‘ç»†èŠ‚ã€‚å¦‚æœä½ æƒ³æ”¯æŒä½ç‰ˆæœ¬çš„è¯ä¹Ÿå¯ä»¥çœ‹çœ‹ç¬”è€…å¯¹ã€ŒWWDC17 - è®©æ‚¨çš„ App æ”¯æŒ CarPlay è½¦è½½ã€å’Œã€ŒWWDC18 - CarPlay è½¦è½½éŸ³é¢‘å’Œå¯¼èˆª Appã€åšçš„ç¬”è®°ã€‚

### ç”³è¯·æƒé™å¹¶é…ç½®å·¥ç¨‹

é¦–å…ˆï¼Œéœ€è¦ç¡®å®šä½ çš„ app æ˜¯å¦é€‚ç”¨äº CarPlayï¼Œç„¶åå»å¼€å‘è€…ç½‘ç«™ç”³è¯·å¯¹åº” app ç±»å‹çš„ CarPlay æƒé™ï¼Œå¹¶å¯¹å·¥ç¨‹è¿›è¡Œé…ç½®ã€‚åªæœ‰è¿™æ ·ä½ çš„å·¥ç¨‹æ‰èƒ½ä½¿ç”¨ CarPlay Simulatorï¼Œå¦åˆ™ä½ çš„ CarPlay Simulator æ— æ³•æ‰“å¼€ï¼ˆç°æ˜¾ç¦ç”¨ï¼‰ã€‚ä¸è¿‡ç¬”è€…æ³¨æ„åˆ°ï¼Œåªè¦ä½ çš„ CarPlay Simulator å¯ç”¨è¿‡ï¼Œå³ä¾¿æ˜¯ä¸æ”¯æŒ CarPlay çš„ app ä¹Ÿæ˜¯å¯ä»¥æ‰“å¼€ CarPlay Simulator çš„ã€‚å› æ­¤ä½ å¯ä»¥è·‘ä¸€é Apple çš„ CarPlay ç¤ºä¾‹ app [CarPlay Music App](https://developer.apple.com/documentation/carplay/integrating_carplay_with_your_music_app?language=objc) æ¥å¯ç”¨ CarPlay Simulatorã€‚

ä¸è¿‡ï¼Œè¦ä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯•ä½ çš„ CarPlay Appï¼Œè¿˜æ˜¯å¾—ä½ è‡ªå·±çš„å·¥ç¨‹æ”¯æŒæ‰è¡Œã€‚

å› æ­¤ï¼Œå¦‚æœä½ è®¡åˆ’è¦å¼€å‘ CarPlay app çš„è¯ï¼Œæœ€å¥½æå‰å»ç”³è¯·æƒé™ï¼Œå› ä¸º Apple å®¡æ ¸è¿˜è¦æ—¶é—´ã€‚åœ¨æ­¤æœŸé—´å¯ä»¥çœ‹çœ‹ç›¸å…³å¼€å‘æ–‡æ¡£ï¼Œç­‰æƒé™ç”³è¯·ä¸‹æ¥å¹¶é…ç½®å¥½å·¥ç¨‹å°±å¯ä»¥ä½¿ç”¨ CarPlay Simulator è°ƒè¯•å¼€å‘å•¦ã€‚

å‚è€ƒæ–‡æ¡£ï¼š[ç”³è¯· CarPlay æƒé™](https://developer.apple.com/documentation/carplay/requesting_the_carplay_entitlements?language=objc)

### ä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯• CarPlay App

æ¯ä¸ª iPhone Simulator éƒ½é™„å¸¦ä¸€ä¸ª CarPlay Simulatorï¼Œåœ¨ **I/O > External Displays > CarPlay** æ‰“å¼€ã€‚é»˜è®¤çš„æ ‡å‡†çš„ CarPlay Simulator çª—å£å¤§å°å’Œæ¯”ä¾‹ä¸º `800 x 480, @2x`ã€‚

å¦‚æœæ˜¯å¯¼èˆªç±» appï¼ŒApple å»ºè®®å¼€å¯ CarPlay Simulator çš„é™„åŠ é€‰é¡¹ï¼Œåœ¨ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤ã€‚è¿™å…è®¸ä½ æ¯æ¬¡å¯åŠ¨ CarPlay Simulator å‰éƒ½å¯ä»¥è®¾ç½®çª—å£å¤§å°å’Œæ¯”ä¾‹ï¼Œä»¥æµ‹è¯•ç¡®ä¿ä½ çš„åœ°å›¾å†…å®¹é€‚é…äº†æ‰€æœ‰æ¨èçš„é…ç½®ã€‚ä¹Ÿè®¸åªæ”¯æŒå¯¼èˆªç±» app å§ï¼ŒéŸ³é¢‘ç±» app æ”¹å˜çª—å£å¤§å°åæ˜¾ç¤ºæ•ˆæœä¸å°½å¦‚äººæ„ï¼Œå»ºè®®å…³é—­ã€‚

```
defaults write com.apple.iphonesimulator CarPlayExtraOptions -bool YES
```

![image-20211109154924029](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211109154924029.png)

å¦‚æœä½ æ‰“å¼€äº† CarPlay Simulator å´æ²¡æœ‰åœ¨ä¸»å±å¹•ä¸Šçœ‹åˆ°ä½ çš„ appï¼Œé‚£ä¹ˆä½ å¯èƒ½æ˜¯å¿˜äº†æ·»åŠ å¯¹åº”çš„æƒåˆ©ã€‚ä½ éœ€è¦å°† Key `com.apple.developer.carplay-audio` æ·»åŠ åˆ° Entitlements.plist ä¸­å¹¶è®¾ç½® Value ä¸º `1`ã€‚

```xml
<key>com.apple.developer.carplay-audio</key>
<true/>
```

å‚è€ƒæ–‡æ¡£ï¼š[ä½¿ç”¨ CarPlay Simulator è¿è¡Œå’Œè°ƒè¯• CarPlay App](https://developer.apple.com/documentation/carplay/using_the_carplay_simulator?language=objc)

å¦‚æœä½ æ˜¯ M1 Macï¼Œé‚£å¯èƒ½æ— æ³•ä½¿ç”¨ CarPlay Simulatorã€‚å¦‚æœä½ çš„ Xcode ä»¥ Rosetta æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆå¯åŠ¨ CarPlay app ä¼šç›´æ¥ crashã€‚å°† Simulator ä¹Ÿä»¥ Rosetta è¿è¡Œï¼Œç»“æœæ— æ•ˆã€‚è¿™ä¸ªé—®é¢˜æš‚æ—¶æ²¡æœ‰è§£å†³æ–¹æ¡ˆã€‚https://issueexplorer.com/issue/mapbox/mapbox-navigation-ios/3355ã€‚

### å£°æ˜ä¸€ä¸ª CarPlay scene

åœ¨ Info.plist ä¸­å£°æ˜ä¸€ä¸ª sceneã€‚

```xml
<key>UIApplicationSceneManifest</key>
<dict>
    <key>UIApplicationSupportsMultipleScenes</key>
		<false/>
		<key>UISceneConfigurations</key>
		<dict>
			<key>CPTemplateApplicationSceneSessionRoleApplication</key>
			<array>
			    <dict>
			        <key>UISceneClassName</key>
			        <string>CPTemplateApplicationScene</string>
			        <key>UISceneConfigurationName</key>
			        <string>CarPlaySceneConfiguration</string>
			        <key>UISceneDelegateClassName</key>
			        <string>$(PRODUCT_MODULE_NAME).CarPlaySceneDelegate</string>
			    </dict>
			</array>
    </dict>
</dict>
```

### å®ç° CarPlaySceneDelegate

```swift
import CarPlay

class CarPlaySceneDelegate: UIResponder, CPTemplateApplicationSceneDelegate {
    var interfaceController: CPInterfaceController?

    func templateApplicationScene(_ templateApplicationScene: CPTemplateApplicationScene,
            didConnect interfaceController: CPInterfaceController) {

        self.interfaceController = interfaceController
        let item = CPListItem(text: "Rubber Soul", detailText: "The Beatles")
        let section = CPListSection(items: [item])
        let listTemplate = CPListTemplate(title: "Albums", sections: [section])
        interfaceController.setRootTemplate(listTemplate, animated: true)
    }

    func templateApplicationScene(_ templateApplicationScene: CPTemplateApplicationScene,
            didDisconnect interfaceController: CPInterfaceController) {
        self.interfaceController = nil
    }
}
```

CPTemplateApplicationSceneDelegate åè®®å®šä¹‰äº† CarPlay åœ¨åœºæ™¯è¿æ¥ã€æ–­å¼€è¿æ¥ã€ä»¥åŠå“åº”æŸäº›ç”¨æˆ·æ“ä½œçš„æ–¹æ³•ã€‚ä½ éœ€è¦åœ¨ CarPlay å¯åŠ¨ä½ çš„ app å¹¶è¿æ¥å…¶åœºæ™¯æ—¶åˆ›å»ºå’Œè®¾ç½®æ ¹æ¨¡æ¿ã€‚ä¸€èˆ¬æˆ‘ä»¬å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š

* [- templateApplicationScene:didConnectInterfaceController:](https://developer.apple.com/documentation/carplay/cptemplateapplicationscenedelegate/3578119-templateapplicationscene?language=objc)

  é€šçŸ¥ä»£ç† CarPlay Scene å·²è¿æ¥ã€‚å½“ app åœ¨è½¦æœºå±å¹•ä¸Šå¯åŠ¨æ—¶ï¼ŒCarPlay framework å°†è°ƒç”¨æ­¤æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¯¹æ¨¡æ¿è¿›è¡Œåˆå§‹åŒ–ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºäº† CPInterfaceController å®ä¾‹ï¼ˆç±»ä¼¼ UINavigationControllerï¼‰ï¼Œä½œä¸ºæˆ‘ä»¬ CarPlay app çš„å…¥å£ controllerï¼Œæˆ‘ä»¬åªéœ€åœ¨å›è°ƒä¸­æŒæœ‰è¿™ä¸ªå®ä¾‹å³å¯ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨æ¨¡æ¿ CPListTemplateï¼ˆç±»ä¼¼ UITableViewï¼‰ï¼Œå…¶æ¥æ”¶å¤šç»„ CPListSectionï¼Œsection ä¸­åŒ…å«å¤šä¸ª CPListItemï¼ˆç±»ä¼¼ UITableViewCellï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„åˆ—è¡¨å…ƒç´ ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°† CPListTemplate è®¾ç½®ä¸º app çš„æ ¹æ¨¡æ¿ï¼ˆç±»ä¼¼ rootViewControllerï¼‰ã€‚

* [- templateApplicationScene:didDisconnectInterfaceController:](https://developer.apple.com/documentation/carplay/cptemplateapplicationscenedelegate/3578120-templateapplicationscene?language=objc)

  é€šçŸ¥ä»£ç† CarPlay Scene å·²æ–­å¼€è¿æ¥ã€‚å½“è½¦æœºæ–­å¼€è¿æ¥æ—¶ï¼Œè¯¥æ–¹æ³•å°†è¢«è°ƒç”¨ï¼Œåœ¨é‡Œé¢å¯ä»¥åšä¸€äº›æ¸…ç†å·¥ä½œã€‚

å‚è€ƒæ–‡æ¡£ï¼š[åœ¨ä½ çš„ CarPlay app ä¸­æ˜¾ç¤ºå†…å®¹](https://developer.apple.com/documentation/carplay/displaying_content_in_carplay?language=objc)

### CarPlay ç•Œé¢æ­å»º

CarPlay app ç•Œé¢åŸºæœ¬å°±æ˜¯ç”± Template å’Œ Item ç»„æˆï¼Œè€ŒéŸ³é¢‘ç±»çš„ CarPlay app åŸºæœ¬ä¸Šä½¿ç”¨ CPTabBarTemplateã€CPListTemplateã€CPListImageRowItemã€CPListItem ç­‰ç­‰å³å¯å®Œæˆç•Œé¢çš„æ­å»ºã€‚

| Templates                                                    | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [CPListTemplate](https://developer.apple.com/documentation/carplay/cplisttemplate?language=objc)<br />- [CPListItem](https://developer.apple.com/documentation/carplay/cplistitem?language=objc)<br />- [CPListImageRowItem](https://developer.apple.com/documentation/carplay/cplistimagerowitem?language=objc)<br />- [CPMessageListItem](https://developer.apple.com/documentation/carplay/cpmessagelistitem?language=objc) | åˆ—è¡¨æ¨¡ç‰ˆï¼ˆç±»ä¼¼ UITableViewï¼‰<br />- ä¸€ä¸ªé€šç”¨çš„ã€å¯é€‰æ‹©çš„åˆ—è¡¨é¡¹ï¼ˆå¯¹åº”ä¸‹å›¾ç¬¬ 2 ä¸ªï¼‰<br />- æ˜¾ç¤ºä¸€ç³»åˆ—å›¾åƒçš„åˆ—è¡¨é¡¹ï¼ˆå¯¹åº”ä¸‹å›¾ç¬¬ 3 ä¸ªï¼‰<br />- è¡¨ç¤ºå¯¹è¯æˆ–è”ç³»äººçš„åˆ—è¡¨é¡¹ï¼ˆç”¨äºä¿¡æ¯ç±» Appï¼‰ï¼ˆå¯¹åº”ä¸‹å›¾ç¬¬ 1 ä¸ªï¼‰ |
| [CPGridTemplate](https://developer.apple.com/documentation/carplay/cpgridtemplate?language=objc) | æ˜¾ç¤ºå’Œç®¡ç† items ç½‘æ ¼çš„æ¨¡ç‰ˆ                                  |
| [CPTabBarTemplate](https://developer.apple.com/documentation/carplay/cptabbartemplate?language=objc) | TabBar æ¨¡ç‰ˆï¼ˆç±»ä¼¼ UITabBarControllerï¼‰                       |

![](https://docs-assets.developer.apple.com/published/49959584ba/rendered2x-1619630673.png)

#### CPTabBarTemplate

TabBar æ¨¡ç‰ˆï¼Œç±»ä¼¼ UIKit ä¸­çš„ UITabBarControllerã€‚ä½¿ç”¨ä¸€ç»„ CPTemplate è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯ä»¥å°†å…¶ä½œä¸º interfaceController çš„ rootTemplateã€‚

```swift
let tabBarTemplate = CPTabBarTemplate(templates: templates)
interfaceController.setRootTemplate(tabBarTemplate, animated: true)
```

![image-20211123143752733](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211123143752733.png)

éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼ŒCPTabBarTemplate çš„ templates æ˜¯æœ‰ä¸ªæ•°é™åˆ¶çš„ï¼Œæœ€å¤§æ•°é‡é€šè¿‡ maximumTabCount ç±»å±æ€§è·å–ï¼Œå®ƒçš„å€¼å–å†³äºåœ¨ Entitlements.plist ä¸­æ·»åŠ çš„æƒåˆ©ï¼ŒéŸ³é¢‘ app æœ€å¤šæ·»åŠ  4 ä¸ªï¼Œè¶…è¿‡æ•°é‡ä¼š crashã€‚

> åœ¨ [WWDC17 - è®©ä½ çš„ App æ”¯æŒ CarPlay è½¦è½½](https://github.com/teney97/iOS-CarPlay/blob/main/Content/WWDC17%20-%20%E8%AE%A9%E6%82%A8%E7%9A%84%20App%20%E6%94%AF%E6%8C%81%20CarPlay%20%E8%BD%A6%E8%BD%BD.md) ä¸­ Apple æåˆ°è¿‡ä½¿ç”¨ MediaPlayer framework æ¥æ„å»ºçš„ CarPlay app æ—¶ï¼Œæ¨èä½¿ç”¨æœ€å¤š 4 ä¸ª tabs å¹¶ä¸”ä½¿ç”¨è¾ƒçŸ­çš„æ ‡é¢˜ï¼Œå› ä¸ºç©ºé—´æœ‰é™å¹¶ä¸”æœ‰äº›æ±½è½¦çš„å±å¹•æ¯”è¾ƒçª„ï¼Œè€Œä¸”æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾çš„æ—¶å€™è¿˜éœ€åœ¨ rootTemplate å³ä¸Šè§’æ˜¾ç¤º â€œæ­£åœ¨æ’­æ”¾â€ æŒ‰é’®ã€‚

```swift
/**
 The maximum number of tabs that your app may display in a @c CPTabBarTemplate,
 depending on the entitlements that your app declares.

 @warning The system will throw an exception if your app attempts to display more
 than this number of tabs in your tab bar template.
 */
open class var maximumTabCount: Int { get }
```

å¯ä»¥è®¾ç½®æ¯ä¸ª template çš„ tab çš„ tabTitle å’Œ tabImageï¼Œä¹Ÿå¯ä»¥è®¾ç½® tabSystemItem ç”¨ç³»ç»Ÿæ ·å¼ï¼ˆå¯ç”¨æ ·å¼è¾ƒå°‘ï¼Œä¸”æ²¡åŠæ³•è‡ªå®šä¹‰æ–‡æ¡ˆäº†ï¼‰ã€‚

```swift
// è‡ªå®šä¹‰ tab æ ·å¼
listTemplate.tabTitle = "æ¨è"
listTemplate.tabImage = UIImage(named: "tabbar_recommend")
// ä½¿ç”¨ç³»ç»Ÿ tab æ ·å¼ï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† tabTitle å’Œ tabImageï¼Œé‚£ä¹ˆ tabSystemItem å°†ä¸ç”Ÿæ•ˆ
listTemplate.tabSystemItem = .favorites
// æ˜¾ç¤ºçº¢ç‚¹
listTemplate.showsTabBadge = true
```

è¿™æ—¶å€™å°±è¦æ‰¾ UI å‡ºå›¾äº†ï¼Œå‚è€ƒæ–‡æ¡£ï¼š[CarPlay UI è®¾è®¡æŒ‡å—](https://developer.apple.com/design/human-interface-guidelines/carplay/icons-and-images/custom-icons/)ã€‚

CPTabBarTemplateDelegate ä»£ç†æ–¹æ³•å°±ä¸€ä¸ªï¼š

```swift
public protocol CPTabBarTemplateDelegate : NSObjectProtocol {
    func tabBarTemplate(_ tabBarTemplate: CPTabBarTemplate, didSelect selectedTemplate: CPTemplate)
}
```

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œä¸ UITabBarController çš„ `- tabBarController:didSelectViewController:` ä¸åŒçš„æ˜¯ï¼š

* åœ¨ CPTabBarTemplate å‘ˆç°å¹¶é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª tab æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥ä»£ç†æ–¹æ³•ä¸€æ¬¡ï¼Œå› æ­¤ä½ éœ€è¦æ³¨æ„åœ¨è¯¥ä»£ç†æ–¹æ³•å®ç°ä¸­æ˜¯å¦éœ€è¦è¿‡æ»¤æ‰ç¬¬ä¸€æ¬¡è°ƒç”¨
* ç‚¹å‡»å½“å‰é€‰ä¸­çš„ tab ä¹Ÿä¼šè°ƒç”¨ä»£ç†æ–¹æ³•ï¼Œå› æ­¤ä½ ä¹Ÿéœ€è¦æ³¨æ„ä¸‹æ˜¯å¦è¿‡æ»¤è¿™ä¸€æƒ…å†µ

#### CPListTemplate

åˆ—è¡¨æ¨¡ç‰ˆï¼Œæœ‰ç‚¹ç±»ä¼¼ UITableviewã€‚å¯ä»¥ä½¿ç”¨ä¸€ç»„ CPListTemplate æ¥åˆå§‹åŒ– CPTabBarTemplateã€‚CPListTemplate ç”±éµå¾ª CPListTemplateItem åè®®çš„ item ç»„æˆï¼Œitem æœ‰ç‚¹ç±»ä¼¼ UITableviewCellã€‚ä¸€èˆ¬éŸ³é¢‘ App å°±ä½¿ç”¨ CPListItem å’Œ CPListImageRowItemã€‚

![image-20211123153134163](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211123153134163.png)

CPListTemplate æœ‰ä¸ªéµå¾ª CPListTemplateDelegate åè®®çš„ delegate å±æ€§ï¼ŒCPListTemplateDelegate å°±ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡» item æ—¶è§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯¥æ–¹æ³•å®ç°ä¸­ push å…¶å®ƒ Templateã€‚

```swift
protocol CPListTemplateDelegate : NSObjectProtocol {
    func listTemplate(_ listTemplate: CPListTemplate, didSelect item: CPListItem, completionHandler: @escaping () -> Void)
}
```

æ³¨æ„è¿™é‡Œæœ‰ä¸ª completionHandler å‚æ•°ã€‚å½“ `- listTemplate:didSelectListItem:completionHandler:` æ–¹æ³•è¢«è°ƒç”¨ï¼Œåœ¨ completionHandler è°ƒç”¨ä¹‹å‰ï¼ŒdidSelectListItem ä¸Šä¼šåœ¨å³è¾¹æ˜¾ç¤ºä¸€ä¸ªæ´»åŠ¨æŒ‡ç¤ºå™¨ã€‚æœ€ä½³å®è·µæ˜¯ï¼Œåœ¨è¦æ’­æ”¾çš„å†…å®¹å·²ç»å‡†å¤‡å¥½ï¼Œæˆ–è€…é¡µé¢è·³è½¬å®Œæˆæ—¶è°ƒç”¨ï¼ˆ`- pushTemplate:animated:completion:` çš„ completion ä¸­ï¼‰ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿè¦ä¿è¯ completionHandler è¢«è°ƒç”¨ï¼Œæ¯”å¦‚æå‰é€€å‡ºæ—¶ï¼Œå¦åˆ™æ´»åŠ¨æŒ‡ç¤ºå™¨ä¼šä¸€ç›´å­˜åœ¨ã€‚

#### CPListImageRowItem

å¯ä»¥ç”¨æ¥å±•ç¤ºç”±ä¸€ç»„ä¸“è¾‘ç»„æˆçš„æ¨¡å—ã€‚ä½¿ç”¨æ–‡æœ¬å’Œä¸€ç»„å›¾ç‰‡åˆå§‹åŒ–ï¼Œæ–‡æœ¬å¯ä»¥å±•ç¤ºæ¨¡å—åç§°ï¼Œå›¾ç‰‡å¯ä»¥å±•ç¤ºæ¨¡å—é‡Œå‰ n ä¸ªä¸“è¾‘çš„å°é¢ã€‚

```swift
// ç»§æ‰¿é“¾ CPListImageRowItem: CPSelectableListItem: CPListTemplateItem
let imagesCount = CPMaximumNumberOfGridImages // å–å†³äºæ±½è½¦æ˜¾ç¤ºå±çš„å¯ç”¨å®½åº¦
let images = Array(repeating: image, count: imagesCount)
let listImageRowItem = CPListImageRowItem(text: text, images: images)
```

![image-20211123153329881](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211123153329881.png)

CPListImageRowItem çš„ç‚¹å‡»åŒºåŸŸå¯ä»¥åˆ†ä¸ºæ¯å¼ å›¾ç‰‡åŒºåŸŸã€å›¾ç‰‡ä»¥å¤–çš„æ‰€æœ‰åŒºåŸŸã€‚

æ¯å¼ å›¾ç‰‡çš„ç‚¹å‡»å›è°ƒé€šè¿‡è®¾ç½® CPListImageRowItem å®ä¾‹çš„ listImageRowHandler å±æ€§æ¥ç›‘å¬ã€‚ç‚¹å‡»å¯ä»¥ push åˆ°è¯¥ä¸“è¾‘çš„éŸ³é¢‘åˆ—è¡¨é¡µé¢ã€‚

```swift
var listImageRowHandler: ((CPListImageRowItem, Int, @escaping () -> Void) -> Void)? // The image row item that the user selected.
```

å›¾ç‰‡ä»¥å¤–çš„åŒºåŸŸçš„ç‚¹å‡»å›è°ƒèµ°çš„æ˜¯ CPListTemplateDelegate çš„æ–¹æ³•ã€‚ç‚¹å‡»å¯ä»¥ push åˆ°è¯¥æ¨¡å—çš„ä¸“è¾‘åˆ—è¡¨é¡µé¢ã€‚

```swift
protocol CPListTemplateDelegate : NSObjectProtocol {
    func listTemplate(_ listTemplate: CPListTemplate, didSelect item: CPListItem, completionHandler: @escaping () -> Void)
}
```

#### CPListItem

å¯ä»¥ç”¨æ¥å±•ç¤ºä¸“è¾‘æˆ–éŸ³é¢‘ï¼Œæˆ–è€…å…¶å®ƒçš„ item å¦‚ â€œæ­£åœ¨åŠ è½½ä¸­â€ã€â€œè¿˜æ²¡æœ‰æ’­æ”¾è®°å½•â€ã€â€æ’­æ”¾å…¨éƒ¨â€œ ç­‰ç­‰ã€‚

å¯¹äºéŸ³é¢‘ itemï¼Œä¸€èˆ¬ç”±éŸ³é¢‘å°é¢ã€éŸ³é¢‘åç§°ã€éŸ³é¢‘æè¿°ç»„æˆï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ„é€ å™¨åˆå§‹åŒ– CPListItemã€‚

```swift
let listItem = CPListItem(text: audioName, 
                          detailText: audioDesc, 
                          image: audioCover)
```

![image-20211123143752733](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211123143752733.png)

ä½¿ç”¨ CPListItem æ¥å±•ç¤ºéŸ³é¢‘ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡ isPlaying å±æ€§æ¥æ˜¾ç¤ºæ­£åœ¨æ’­æ”¾çš„æ ‡å¿—ï¼š

```swift
var isPlaying: Bool
```

![image-20211125115803820](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211125115803820.png)

å¯¹äºä¸“è¾‘ itemï¼Œè¿˜éœ€è¦å³è¾¹çš„å¯¼èˆªç®­å¤´æ¥å’ŒéŸ³é¢‘ item åšåŒºåˆ†ï¼ŒæŒ‡ç¤ºç”¨æˆ·ç‚¹å‡»å¯ä»¥æ‰“å¼€éŸ³é¢‘åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ„é€ å™¨åˆå§‹åŒ– CPListItemã€‚

```swift
let listItem = CPListItem(text: albumName, 
                          detailText: albumDesc, 
                          image: albumCover, 
                          accessoryImage: nil, 
                          accessoryType: .disclosureIndicator)
```

å³è¾¹çš„å›¾æ ‡æœ‰ä¸¤ä¸ªç³»ç»Ÿæ ·å¼ï¼ˆç®­å¤´ã€äº‘æœµï¼‰ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒè‡ªå®šä¹‰ã€‚

```swift
enum CPListItemAccessoryType : Int {
    case none = 0
    case disclosureIndicator = 1
    case cloud = 2
}
```

![image-20211123154215694](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211123154215694.png)

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœ CPListItem çš„ detailText ä¸º nil çš„è¯ï¼Œview é«˜åº¦ä¼šå‡å°ï¼Œå¹¶å°† text å±…ä¸­æ˜¾ç¤ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™ä¼šå½±å“ç¾è§‚ä»¥åŠæ•´ä½“ç»Ÿä¸€æ€§ã€‚å› æ­¤ï¼Œä½ å¯ä»¥è€ƒè™‘å½“éŸ³é¢‘æ²¡æœ‰å‰¯æ ‡é¢˜æ—¶ï¼Œä½¿ç”¨éŸ³é¢‘æ—¶é•¿æˆ–å…¶å®ƒæ•°æ®å¡«å…… detailTextã€‚

![image-20211124091144806](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211124091144806.png)

#### CPNowPlayingTemplate

è¿™æ˜¯éŸ³é¢‘ç±» CarPlay app æœ€é‡è¦çš„é¡µé¢äº†ï¼Œä½¿ç”¨ CPNowPlayingTemplateï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¾‹ã€‚

ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é…ç½® CPNowPlayingTemplateï¼Œæ¯”å¦‚æ·»åŠ æ§åˆ¶æŒ‰é’®ã€‚ä½ å¯ä»¥ä½¿ç”¨ CarPlay framework æä¾›çš„ä¸€äº›ç³»ç»ŸæŒ‰é’®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æŒ‰é’®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ è¦åœ¨ `- templateApplicationScene:didConnectInterfaceController:` çš„æ—¶æœºå°±é…ç½®å¥½ CPNowPlayingTemplateï¼Œè€Œä¸åº”è¯¥åœ¨ push åˆ° CPNowPlayingTemplate çš„æ—¶å€™æ‰å»é…ç½®ï¼Œå› ä¸º CPNowPlayingTemplate å¹¶ä¸ä¸€å®šæ˜¯é€šè¿‡ä¸»åŠ¨ push æ—¶è§¦å‘ï¼Œè¿˜å¯èƒ½æ˜¯é€šè¿‡ â€œæ’­æ”¾ä¸­â€ app æˆ–è€… rootTemplate å³ä¸Šè§’çš„ â€œæ­£åœ¨æ’­æ”¾æŒ‰é’®â€ã€‚

```swift
let nowPlayingTemplate = CPNowPlayingTemplate.shared
let repeatButton = CPNowPlayingRepeatButton() { ... }
let playbackRateButton = CPNowPlayingPlaybackRateButton() { ... }
nowPlayingTemplate.updateNowPlayingButtons([repeatButton, playbackRateButton])
```

æ— è®ºä½ ä½¿ç”¨ CarPlay framework è¿˜æ˜¯ MediaPlayer framework æ¥æ„å»ºçš„ CarPlay appï¼Œéƒ½æ˜¯é€šè¿‡ MPNowPlayingInfoCenter å’Œ MPRemoteCommandCenter æ¥æä¾›æ’­æ”¾ç•Œé¢çš„éŸ³é¢‘ä¿¡æ¯ä»¥åŠå“åº”æ’­æ”¾æ§åˆ¶äº‹ä»¶ã€‚åªä¸è¿‡åœ¨ CarPlay framework ä¸­ï¼Œä¸€äº› remote command äº‹ä»¶é€šè¿‡ button handle æ¥å¤„ç†äº†ï¼Œæ¯”å¦‚æ’­æ”¾æ¨¡å¼ã€æ’­æ”¾é€Ÿç‡ç­‰ç­‰ã€‚å½“ç„¶å¦‚æœä½ çš„ app æ˜¯éŸ³é¢‘ç±»çš„è¯ï¼Œåº”è¯¥å·²ç»æ”¯æŒäº†è¿™äº›åŠŸèƒ½ï¼Œå› ä¸º iPhone é”å±ç•Œé¢ä»¥åŠæ§åˆ¶ä¸­å¿ƒçš„éŸ³é¢‘æ’­æ”¾ä¿¡æ¯å’Œæ’­æ”¾æ§åˆ¶ä¹Ÿæ˜¯é€šè¿‡å®ƒä»¬æä¾›ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹ CarPlay åšä¸‹ä¼˜åŒ–æˆ–è€…åŠŸèƒ½å¢å¼ºå°±è¡Œã€‚æˆ‘ä»¬å…·ä½“è¦åšçš„æ˜¯ï¼š

* è®¾ç½®å’Œæ›´æ–° MPNowPlayingInfoCenter çš„ nowPlayingInfoï¼Œå®ƒåŒ…å«å½“å‰æ’­æ”¾éŸ³é¢‘çš„å…ƒæ•°æ®ï¼Œå¦‚æ ‡é¢˜ã€ä½œè€…ã€æ—¶é•¿ç­‰ç­‰ã€‚æ—¶æœºï¼š

  * åˆ‡æ¢éŸ³é¢‘ï¼ˆä¸Šä¸€é¦–ã€ä¸‹ä¸€é¦–ç­‰ç­‰ï¼‰
  * æš‚åœã€æ¢å¤ã€åœæ­¢æ’­æ”¾
  * seekï¼ˆè·³è¿‡ç‰‡å¤´ã€æ‹–åŠ¨è¿›åº¦ç­‰ç­‰ï¼‰
  * æ›´æ–°æ’­æ”¾é€Ÿç‡ï¼ˆCPNowPlayingTemplate ä¸­æ’­æ”¾é€Ÿç‡æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰
  * ...

```swift
import MediaPlayer
// Set Metadata to be Displayed in Now Playing Info Center
let infoCenter = MPNowPlayingInfoCenter.default()
infoCenter.nowPlayingInfo = [MPMediaItemPropertyTitle: "Style",
                             MPMediaItemPropertyArtist: "Taylor Swift",
                             MPMediaItemPropertyAlbumTitle: "1989",
                             MPMediaItemPropertyGenre: "Pop",
                             MPMediaItemPropertyReleaseDate: "2014",
                             MPMediaItemPropertyPlaybackDuration: 231,
                             MPMediaItemPropertyArtwork: mediaItemArtwork,
                             MPNowPlayingInfoPropertyElapsedPlayback: 53,
                             MPNowPlayingInfoPropertyDefaultPlaybackRate: 1,
                             MPNowPlayingInfoPropertyPlaybackRate: 1,
                             MPNowPlayingInfoPropertyPlaybackQueueCount: 13,
                             MPNowPlayingInfoPropertyPlaybackQueueIndex: 3,
                            â€¦ ]
```

éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¯¹äºæ’­æ”¾è¿›åº¦ä¹Ÿå°±æ˜¯å½“å‰éŸ³é¢‘å·²ç»æ’­æ”¾çš„æ—¶é•¿çš„æ›´æ–°ï¼Œç³»ç»Ÿä¼šæ ¹æ®å…ˆå‰æä¾›çš„å·²æ’­æ”¾æ—¶é•¿å’Œæ’­æ”¾é€Ÿç‡è‡ªåŠ¨æ¨æ–­å‡ºæ¥ã€‚å› æ­¤ä¸éœ€è¦ä¹Ÿä¸æ¨èé¢‘ç¹æ›´æ–° nowPlayingInfoï¼Œè¿™ä»£ä»·å¾ˆå¤§ã€‚

* é™¤äº† nowPlayingInfoï¼Œè¿˜æœ‰ä¸€äº›çŠ¶æ€éœ€è¦é€šè¿‡å…¶å®ƒæ–¹å¼åŒæ­¥åˆ° CarPlay appï¼Œæ¯”å¦‚ï¼š

  * éŸ³é¢‘æ’­æ”¾çŠ¶æ€ï¼šæš‚åœ/æ’­æ”¾ï¼ˆCPNowPlayingTemplate ä¸­æ’­æ”¾æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰

  ```objectivec
  if (@available(iOS 13.0, *)) {
      MPNowPlayingInfoCenter.defaultCenter.playbackState = MPNowPlayingPlaybackStatePlaying; 
      // MPNowPlayingPlaybackStatePausedã€MPNowPlayingPlaybackStateStopped
  }
  ```
  
  * æ’­æ”¾æ¨¡å¼çŠ¶æ€ï¼šé¡ºåºå¾ªç¯/å•æ›²å¾ªç¯ï¼ˆCPNowPlayingTemplate ä¸­æ’­æ”¾æ¨¡å¼æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€ï¼‰
  
  ```objectivec
  MPRemoteCommandCenter.sharedCommandCenter.changeRepeatModeCommand.currentRepeatType = repeatType;
  ```

ä¸‹å›¾ä¸­çš„éŸ³é¢‘åç§°ã€éŸ³é¢‘æè¿°ã€éŸ³é¢‘æ—¶é•¿ã€å½“å‰æ’­æ”¾è¿›åº¦ã€æ’­æ”¾æ¨¡å¼ã€æ’­æ”¾é€Ÿç‡ç­‰éŸ³é¢‘æ’­æ”¾ä¿¡æ¯ï¼Œéƒ½æ˜¯é€šè¿‡ä»¥ä¸Šæ–¹å¼åŒæ­¥æ˜¾ç¤ºåˆ° CPNowPlayingTemplate ä¸Šçš„ã€‚ä½ çš„éŸ³é¢‘ app ä¹‹å‰åº”è¯¥å·²ç»å®ç°äº†è¯¥åŠŸèƒ½ä»¥å°†éŸ³é¢‘æ’­æ”¾ä¿¡æ¯åŒæ­¥åˆ° iPhone é”å±ç•Œé¢ä»¥åŠæ§åˆ¶ä¸­å¿ƒï¼Œç°åœ¨åªéœ€è¦æ£€æŸ¥ä¸‹ CarPlay app çš„ CPNowPlayingTemplate ä¸­çš„éŸ³é¢‘æ’­æ”¾ä¿¡æ¯æ˜¯å¦å‡†ç¡®å³å¯ã€‚

![image-20211116113630475](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211116113630475.png)

* å“åº” MPRemoteCommandCenter äº‹ä»¶ï¼Œå¯¹ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æ§åˆ¶æŒ‰é’®åšå‡ºå“åº”ï¼Œå¦‚æ’­æ”¾ã€æš‚åœã€åˆ‡æ¢æ­Œæ›²ç­‰ç­‰ã€‚

  * playCommand
  * pauseCommand
  * previousTrackCommand
  * nextTrackCommand
  * togglePlayPauseCommand
  * changeRepeatModeCommand
  * changePlaybackRateCommand
  * ...
* ä½¿ç”¨ CarPlay framework æ—¶ï¼ŒchangeRepeatModeCommandã€changePlaybackRateCommand ä¸å†ç”± MPRemoteCommandCenter è§¦å‘ï¼Œè€Œæ˜¯é€šè¿‡ CPNowPlayingRepeatButtonã€CPNowPlayingPlaybackRateButton çš„ handle ç›‘å¬ã€‚ä½† command.enabled è¿˜æ˜¯è¦å¼€å¯ã€‚

```
// Discussion
CPNowPlayingRepeatButton is a concrete subclass of CPNowPlayingButton. Use the buttonâ€™s handler to invoke your existing functionality for cycling through repeat modes, using the same MPChangeRepeatModeCommand that you provide to MPRemoteCommandCenter.
CarPlay uses MPRemoteCommandCenter to observe changes to the repeat mode and updates the buttonâ€™s appearance accordingly.
```

#### ä½¿ç”¨ userInfo å­˜å‚¨æ•°æ®

CPListItemã€CPListImageRowItem éƒ½æœ‰ä¸ª [userInfo](https://developer.apple.com/documentation/carplay/cplistitem/2977574-userinfo?language=objc) å±æ€§ï¼Œå®ƒç”¨æ¥å­˜å‚¨æ•°æ®ã€‚`CPListItem -> userInfo` å…³ç³»å°±ç±»ä¼¼äº `UITableViewCell -> model`ã€‚

```swift
// Use this property to attach a value that provides additional context to the list item. For example, you can attach a model object and reference it in the list itemâ€™s handler when processing the selection.
var userInfo: Any?
```

#### é€šè¿‡ isEnabled è®¾ç½® item çš„å¯äº¤äº’æ€§ï¼ˆiOS 15ï¼‰

CPListItemã€CPListImageRowItem éƒ½æœ‰ä¸ª [isEnabled](https://developer.apple.com/documentation/carplay/cplistitem/3751895-enabled?language=objc) å±æ€§ï¼Œå®ƒç”¨æ¥è®¾ç½® item çš„å¯äº¤äº’æ€§ï¼ˆé»˜è®¤å€¼ä¸º trueï¼‰ã€‚isEnabled è®¾ç½®ä¸º false çš„ item å°†ä¸å¯ç‚¹å‡»ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè§¦å‘ `- listTemplate:didSelectListItem:completionHandler:` æ–¹æ³•ã€‚æœ€ä½³å®è·µæ˜¯ï¼Œå°† â€œè¿˜æ²¡æœ‰æ’­æ”¾è®°å½•â€ã€â€œæ­£åœ¨åŠ è½½ä¸­â€ è¿™äº›æœ¬èº«å°±æ²¡æœ‰äº¤äº’çš„ item çš„ isEnabled è®¾ç½®ä¸º falseï¼Œè¿™æ ·å‘ˆç°çš„ UI æ•ˆæœæ›´å¥½ï¼Œè€Œä¸”ä½ ä¹Ÿä¸ç”¨åœ¨ `- listTemplate:didSelectListItem:completionHandler:`  å¯¹è¿™äº› item åš guard å¤„ç†äº†ã€‚ä¸è¿‡è¯¥ API åœ¨ iOS 15 å¼€å§‹æ‰æ”¯æŒ ğŸ˜­ï¼Œä½†æˆ‘ä»¬è¿˜æœ‰å…¶å®ƒæ–¹å¼å¯ä»¥é¿å…åœ¨ didSelectListItem æ–¹æ³•ä¸­åš guard å¤„ç†ï¼Œé‚£å°±æ˜¯ç”¨ item çš„ handle å±æ€§ã€‚

```swift
// A Boolean value that indicates if the item is enabled.
@available(iOS 15.0, *)
var isEnabled: Bool
```

#### ä½¿ç”¨ handle å“åº” item çš„ç‚¹å‡»äº‹ä»¶

CPListItemã€CPListImageRowItem éƒ½æœ‰ä¸ª [handle](https://developer.apple.com/documentation/carplay/cplistitem/3667716-handler?language=objc) å±æ€§ï¼Œç”¨æ¥å“åº” item çš„ç‚¹å‡»äº‹ä»¶ã€‚å¦‚æœä½ ç»™ item è®¾ç½®äº† handleï¼Œé‚£ä¹ˆç‚¹å‡» item å°†è§¦å‘ handle è€Œä¸è§¦å‘ didSelectListItem æ–¹æ³•ã€‚

```swift
// An optional action block, fired when the user selects this item in a list template.
var handler: ((CPSelectableListItem, @escaping () -> Void) -> Void)?
```

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ handle æŠŠä¸€äº›ç‰¹æ®Š item çš„ç‚¹å‡»äº‹ä»¶å‰¥ç¦»å‡ºæ¥ï¼Œè€Œä¸æ˜¯å…¨éƒ¨æ”¾åˆ° `- listTemplate:didSelectListItem:completionHandler:` å¤„ç†ï¼Œè¿™æ ·å¯ä»¥**æé«˜ä»£ç å¯ç»´æŠ¤æ€§**ã€‚å¯¹äºä¸Šé¢è¯´çš„ isEnabled ä»…åœ¨ iOS 15 ä»¥ä¸Šæ‰æ”¯æŒçš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åƒä¸‹é¢è¿™æ ·å¤„ç†ï¼Œä»¥é¿å…åœ¨ didSelectListItem æ–¹æ³•ä¸­åš guard å¤„ç†ã€‚

```swift
let item = CPListItem(text: "æ­£åœ¨åŠ è½½ä¸­", detailText: nil)
if #available(iOS 15.0, *) {
    item.isEnabled = false
} else {
    item.handler = { (item, completionHandler) in
        completionHandler()
    }
}
```



### é¡µé¢è·³è½¬

è¿˜è®°å¾—åœ¨ CarPlay app å…¥å£ [- templateApplicationScene:didConnectInterfaceController:](https://developer.apple.com/documentation/carplay/cptemplateapplicationscenedelegate/3578119-templateapplicationscene?language=objc) ä¸­çš„ CPInterfaceController å—ï¼Œå®ƒä½œä¸ºæˆ‘ä»¬ CarPlay app çš„å…¥å£ controllerï¼Œæˆ‘ä»¬å°†ä¸€ä¸ª template ä½œä¸º rootTemplate èµ‹å€¼ç»™å®ƒã€‚å½“æˆ‘ä»¬è¦è¿›è¡Œé¡µé¢è·³è½¬æ—¶ä¹Ÿæ˜¯é å®ƒï¼Œæœ‰ç‚¹ç±»ä¼¼äº UINavigationControllerï¼Œå®ƒæ”¯æŒ pushã€popã€presentã€dismiss ç­‰ç­‰æ“ä½œï¼ˆpresentã€dismiss æ“ä½œä»… CPActionSheetTemplateã€CPVoiceControlTemplateã€CPAlertTemplateï¼‰ã€‚

### å›¾ç‰‡

#### å›¾æ ‡å’Œå›¾ç‰‡

å¯ä»¥çœ‹çœ‹ [CarPlay - è®¾è®¡æŒ‡å—](https://developer.apple.com/design/human-interface-guidelines/carplay/overview/introduction/)ï¼Œå¹¶å°†å®ƒå‘ç»™ä½ çš„ PM å’Œ UIã€‚

#### å¼‚æ­¥å›¾ç‰‡

* CarPlay ä¸æ”¯æŒ GIF å›¾ç‰‡ï¼Œé…ç½®ä¼šå¯¼è‡´ crashã€‚ç¬”è€…å°è¯•å–å‡º GIF å›¾çš„ç¬¬ä¸€å¸§ï¼Œå‘ç°è¿˜æ˜¯ä¸æ”¯æŒï¼Œä¹Ÿè®¸æ˜¯æˆ‘çš„æ–¹å¼æœ‰é—®é¢˜ã€‚
* asyncImage ä¹Ÿéœ€è¦é€‚é…ä¸‹ scaleï¼Œå¦åˆ™ä¼šæ¨¡ç³Šã€‚
* å¯ä»¥å¯¹ CPListItem å’Œ CPListImageRowItem æ‰©å±•ä¸‹ asyncImage çš„æ–¹æ³•ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚

```swift
@available(iOS 14, *)
protocol CPAsyncImage {
    func loadImage(with url: URL?, complete: @escaping (UIImage?) -> (Void))
    static var placeholderImage: UIImage { get }
}

@available(iOS 14, *)
extension CPAsyncImage {
    
    func loadImage(with url: URL?, complete: @escaping (UIImage?) -> (Void)) {
        
        guard let url = url else {
            complete(nil)
            return
        }
        
        // è¿™å„¿ä¹Ÿå¯ä»¥æ ¹æ® urlType åšä¸‹è¿‡æ»¤
        
        SDWebImageManager.shared.loadImage(with: url, options: .retryFailed, progress: nil) { image, data, error, type, finished, imageURL in
            
            guard var image = image, image.images == nil else {
                complete(nil)
                return
            }
                   
            if let cgImage = image.cgImage {
                let screen = TTScenes.carPlayScene?.value(forKey: "screen") as? UIScreen
                let scale = screen?.scale ?? 1
                image = UIImage(cgImage: cgImage, scale: scale, orientation: .up)
            }
            complete(image)
        }
    }
    
    static var placeholderImage: UIImage {
        UIImage(named: "CP_default") ?? UIImage()
    }
}

@available(iOS 14, *)
extension CPListItem: CPAsyncImage {
    
    func asyncImage(with url: URL?, placeholderImage: UIImage? = CPListItem.placeholderImage, complete: ((UIImage?) -> (Void))? = nil) {
        
        self.setImage(placeholderImage)
        loadImage(with: url) { [weak self] image in
            guard let image = image else { return }
            self?.setImage(image)
            complete?(image)
        }
    }
}

@available(iOS 14, *)
extension CPListImageRowItem: CPAsyncImage {
    
    func asyncImage(with urls: [URL?], placeholderImage: UIImage = CPListImageRowItem.placeholderImage, complete: (((index: Int, image: UIImage?)) -> (Void))? = nil) {
        
        var images = Array(repeating: placeholderImage, count: urls.count)
        self.update(images)
        
        for (index, url) in urls.enumerated() {
            loadImage(with: url) { [weak self] image in
                guard let image = image else { return }
                images[index] = image
                self?.update(images)
                complete?((index, image))
            }
        }
    }
}
```

### é‡æ–°åŠ è½½æ•°æ®

ç½‘ç»œä¸å¥½çš„æƒ…å†µä¸‹å¯åŠ¨ CarPlay appï¼Œå¯èƒ½å°±ä¼šå­˜åœ¨è¯·æ±‚è¶…æ—¶ï¼ŒCarPlay app ä¸­æ— æ•°æ®ã€‚å¤„ç†æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

* ä¸é‡æ–°åŠ è½½ã€‚å¦‚æœæ˜¯é¦–é¡µï¼Œåˆ™ç”¨æˆ·éœ€è¦é‡æ–°å¯åŠ¨ CarPlay app æ‰èƒ½é‡æ–°åŠ è½½ï¼›å¦‚æœæ˜¯å­é¡µé¢ï¼Œåˆ™ç”¨æˆ·éœ€è¦é€€å‡ºå¹¶é‡æ–°è¿›å…¥å­é¡µé¢æ‰èƒ½é‡æ–°åŠ è½½ã€‚çœ‹äº†ç½‘æ˜“äº‘ CarPlay app å°±æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œä¸è¿‡å®ƒçš„é¦–é¡µæœ‰å›ºå®šçš„å‡ ä¸ª itemï¼Œå€’æ˜¯ä¸å½±å“ä½“éªŒã€‚å¦‚æœä½ çš„é¦–é¡µå†…å®¹å…¨éƒ¨å–è‡ªæœåŠ¡ç«¯ï¼Œé‚£ä¸å»ºè®®ä»¥è¿™ç§æ–¹å¼å¤„ç†ï¼›
* å¦‚æœ rootTemplate æ˜¯ CPTabBarTemplateï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨ `- tabBarTemplate:didSelectTemplate:` æ—¶æœºè¿›è¡Œé‡æ–°åŠ è½½æ“ä½œï¼›
* å¯¹äºç¬¬äºŒç§æ–¹å¼ï¼Œé‡æ–°åŠ è½½å¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºä½ æ²¡åŠæ³•æˆ–è€…ä¸æ–¹ä¾¿è‡ªå·±æ·»åŠ ä¸ªæ´»åŠ¨æŒ‡ç¤ºå™¨ã€‚æˆ‘çš„åšæ³•ï¼Œæˆ‘ä¹Ÿè®¤ä¸ºæ˜¯æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯ï¼Œåœ¨è¯·æ±‚æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œæ·»åŠ ä¸ªåŠ è½½ä¸­ itemï¼ˆæ¯”å¦‚ä½¿ç”¨ CPListTemplate å¹¶æ˜¾ç¤º â€œæ­£åœ¨åŠ è½½ä¸­â€ï¼‰ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåˆ™æ›´æ–° item ä¸ºé‡è¯• itemï¼ˆæ¯”å¦‚ä½¿ç”¨ CPListTemplate å¹¶æ˜¾ç¤º â€œåŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•â€ï¼‰ã€‚å½“ç”¨æˆ·ç‚¹å‡»é‡è¯• item æ—¶ï¼Œæ›´æ–° item ä¸ºåŠ è½½ä¸­ itemï¼Œå¹¶é‡æ–°è¯·æ±‚æ•°æ®ã€‚å¯¹äºæ¯ä¸ªéœ€è¦ä»æœåŠ¡ç«¯æ‹‰å–æ•°æ®çš„é¡µé¢éƒ½å¯ä»¥è¿™æ ·å¤„ç†ã€‚
* æ˜¯å¦éœ€è¦åˆ·æ–°ï¼Ÿå¦‚æœæƒ³è¦å…è®¸ä½¿ç”¨ CarPlay app çš„è¿‡ç¨‹ä¸­å»åˆ·æ–°æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ç¬¬äºŒç§æ–¹å¼å¤„ç†ã€‚ä¸è¿‡æˆ‘è®¤ä¸ºï¼Œç”¨æˆ·å•æ¬¡ä½¿ç”¨ CarPlay çš„æ—¶é—´ä¸ä¼šå¾ˆé•¿ï¼Œæ²¡æœ‰å¿…è¦åšåˆ·æ–°ï¼Œä¸‹æ¬¡å¯åŠ¨çš„æ—¶é—´æ‹‰å–æ–°æ•°æ®å°±å¥½ã€‚å› æ­¤ï¼Œæˆ‘åªé’ˆå¯¹é¦–æ¬¡æ•°æ®åŠ è½½å¤±è´¥çš„æƒ…å†µåšäº†é‡æ–°åŠ è½½å¤„ç†ã€‚

### åŸ‹ç‚¹

ä¸€äº›åŸ‹ç‚¹å¯èƒ½éœ€è¦é€šè¿‡æŠ•æœºå–å·§çš„æ–¹æ³•ï¼Œæ¯”å¦‚åœ¨å“ªä¸ªé¡µé¢è§¦å‘äº†è¿”å›æŒ‰é’®ï¼Œå¯ä»¥é€šè¿‡ `templateDidAppear`ã€`templateWillDisappear` ç­‰æ–¹æ³•é…åˆå®ç°ã€‚emmm... åŠ äº†åŸ‹ç‚¹åä»£ç ä¸€ç‚¹å„¿ä¹Ÿä¸ç®€æ´äº†ã€‚

## æ³¨æ„ç‚¹ & æœ€ä½³å®è·µ

* å•ä¾‹é—®é¢˜ã€‚CarPlay ç”¨åˆ°äº†å•ä¾‹ç±»ï¼ŒCarPlay app å…³é—­ï¼Œä½† iPhone app æ²¡å…³é—­ï¼Œè¿›ç¨‹æ˜¯è¿˜åœ¨çš„ï¼Œå•ä¾‹è¿˜æœªé‡Šæ”¾ï¼Œå¯èƒ½ä¼šé€ æˆä¸€äº›é—®é¢˜ã€‚å¯ä»¥åœ¨ `- templateApplicationScene:didConnectInterfaceController:` ä¸­åˆå§‹åŒ–å•ä¾‹ï¼Œåœ¨ `- templateApplicationScene:didDisconnectInterfaceController:` ä¸­é‡Šæ”¾å•ä¾‹ã€‚
* TabBarï¼Œå¦‚æœ tabImage ä¸º nilï¼Œé‚£ä¹ˆè¯¥ tabBarItem å°†ä¼šä½¿ç”¨ UITabBarItem.SystemItem.moreã€‚
* æ•°æ®å¯ä»¥å­˜åœ¨ CPListItem.userInfoï¼Œä¸éœ€è¦æ‰©å±•å±æ€§ã€‚å®ƒæ˜¯å¼ºå¼•ç”¨ï¼Œéœ€è¦æ³¨æ„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚
* CarPlay Simulator çš„è¯­è¨€æ˜¯è·Ÿéš iPhone Simulator çš„ï¼ŒçœŸæœºæ˜¯å¦ä¹Ÿå¦‚æ­¤æˆ‘æ²¡æœ‰æµ‹è¯•è¿‡ã€‚
* CarPlay Framework éœ€è¦è®¾ç½®ä¸ºå¼±å¼•ç”¨ optionalï¼ˆTarget > Build phases > Link Binary With Librariesï¼‰ï¼Œå¦åˆ™åœ¨ iOS 14 ä»¥ä¸‹å¯åŠ¨ App ä¼š crashã€‚
* CarPlay æ–­å¼€è¿æ¥æ—¶ï¼Œå»ºè®®æš‚åœéŸ³ä¹ã€‚
* CarPlay æ–­å¼€è¿æ¥æ—¶ï¼Œå¯ä»¥é€šè¿‡ Memory Graph æ£€æŸ¥ä¸‹æœ‰æ— å†…å­˜æ³„æ¼ã€‚
* Template é¡µé¢æœ€å¥½è‡³å°‘æ˜¾ç¤ºä¸€é¡¹å†…å®¹ï¼Œç‰¹åˆ«æ˜¯ä½ æ²¡æœ‰ä½¿ç”¨ CPTabBarTemplate ä½œä¸º rootTemplate çš„æƒ…å†µï¼Œå¦åˆ™é¡µé¢å°†ä¸€ç‰‡ç©ºç™½ã€‚ä¾‹å¦‚ï¼Œåœ¨æœ€è¿‘æ’­æ”¾é¡µé¢ï¼Œå½“æ²¡æœ‰æ’­æ”¾è®°å½•æ—¶ï¼Œæˆ‘å¡«å……äº†ä¸€ä¸ª CPListTemplate å¹¶æ˜¾ç¤º â€œå½“å‰æ²¡æœ‰æ’­æ”¾è®°å½•â€ã€‚

## å¸¸è§é—®é¢˜è§£ç­”

### CarPlay è¿æ¥

**1. ä¸ºä»€ä¹ˆè½¦æœºè¿æ¥äº†ï¼ŒCarPlay è½¦è½½å´æ²¡æœ‰å‡ºæ¥ï¼Ÿ**

* æ±½è½¦ä¸æ”¯æŒ CarPlayï¼›
* iPhone æ²¡æœ‰å¼€å¯ Siriã€‚åœ¨ `è®¾ç½® > Siri ä¸æœç´¢` ä¸­å¼€å¯ `ç”¨â€œå˜¿ Siriâ€å”¤é†’`ã€‚å¦‚æœæ²¡æœ‰å¼€å¯ Siri çš„è¯ï¼ŒiPhone çš„ `è®¾ç½® > é€šç”¨ ` ä¸­ä¹Ÿä¸ä¼šæ˜¾ç¤º `CarPlay è½¦è½½` è¿™ä¸€é¡¹ã€‚

### Simulator

**1. ä¸ºä»€ä¹ˆ Simulator èœå•æ  I/O > External Displays ä¸­æ²¡æœ‰ CarPlay é€‰é¡¹ï¼Ÿ**

ä½ å¯èƒ½è¿˜æœªåœ¨å¼€å‘è€…ç½‘ç«™ç”³è¯· CarPlay æƒé™å¹¶å°†é…ç½®æ–‡ä»¶å¯¼å…¥åˆ°å·¥ç¨‹ä¸­ã€‚[ç”³è¯· CarPlay æƒé™](https://developer.apple.com/documentation/carplay/requesting_the_carplay_entitlements?language=objc)

**2. ä¸ºä»€ä¹ˆæ‰“å¼€ CarPlay Simulator æ²¡æœ‰æ˜¾ç¤ºæˆ‘çš„ appï¼Ÿ**

ä½ å¯èƒ½æ˜¯å¿˜äº†æ·»åŠ æƒåˆ©æ–‡ä»¶ã€‚ä½ éœ€è¦å°† Key `com.apple.developer.carplay-audio` æ·»åŠ åˆ° Entitlements.plist ä¸­å¹¶è®¾ç½® Value ä¸º `1`ã€‚

```xml
<key>com.apple.developer.carplay-audio</key>
<true/>
```

å¯ä»¥å‚è€ƒ [ç”³è¯· CarPlay æƒé™](https://developer.apple.com/documentation/carplay/requesting_the_carplay_entitlements?language=objc)ã€‚

**3. ä¸ºä»€ä¹ˆ M1 Mac æ‰“å¼€ CarPlay app ç›´æ¥å´©æºƒï¼Ÿ** 

å¦‚æœä½ çš„ Xcode ä»¥ Rosetta æ¨¡å¼è¿è¡Œï¼Œé‚£å°†æ— æ³•ä½¿ç”¨ CarPlay Simulatorã€‚å°† Simulator ä¹Ÿä»¥ Rosetta è¿è¡Œï¼Œç»“æœæ— æ•ˆã€‚è¿™ä¸ªé—®é¢˜æš‚æ—¶æ²¡æœ‰è§£å†³æ–¹æ¡ˆã€‚https://issueexplorer.com/issue/mapbox/mapbox-navigation-ios/3355ã€‚

**4. ä» â€œæ’­æ”¾ä¸­â€ app è¿”å›åˆ°éŸ³é¢‘æº appï¼Œé¡µé¢æ˜¾ç¤ºå¼‚å¸¸**

æ„Ÿè§‰æ˜¯ Apple çš„ bugï¼Œæ¨¡æ‹Ÿå™¨å’ŒçœŸæœºéƒ½å¯èƒ½å‡ºç°ã€‚bug å‡ºç°çš„æ­¥éª¤æ˜¯ï¼š

1. å…ˆä¸è¦å¯åŠ¨ä½ çš„ CarPlay app
2. åœ¨ä½ çš„ iPhone app ä¸­æ’­æ”¾éŸ³é¢‘
3. æ‰“å¼€ CarPlay çš„ â€œæ’­æ”¾ä¸­â€ app
4. é€šè¿‡ â€œæ’­æ”¾ä¸­â€ app è¿”å›åˆ°ä½ çš„ CarPlay app

å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜ï¼š

* tabBarItem é‡å 
* CPListImageRowItem æœ¬åº”è¯¥åªæ˜¾ç¤º 4 å¼ å›¾ç‰‡ï¼Œå´æ˜¾ç¤ºäº† 5 å¼ 

åˆ‡æ¢ templateã€é€€åå°å†è¿›å…¥ï¼Œé¡µé¢æ¢å¤æ­£å¸¸ã€‚

### å›¾ç‰‡

**1. ä¸ºä»€ä¹ˆ CarPlay ä¸Šçš„å›¾ç‰‡æ¨¡ç³Šï¼Ÿ**

æ— è®ºæ˜¯æœ¬åœ°å›¾ç‰‡è¿˜æ˜¯å¼‚æ­¥å›¾ç‰‡éƒ½éœ€è¦é€‚é…ä¸‹ scaleã€‚

### æ­£åœ¨æ’­æ”¾

**1. rootTemplate å³ä¸Šè§’çš„ â€œæ­£åœ¨æ’­æ”¾æŒ‰é’®â€ ä»€ä¹ˆæ—¶å€™å‡ºç°ï¼Ÿ**

å½“å‰ app æ­£åœ¨æ’­æ”¾éŸ³é¢‘æ—¶å‡ºç°ï¼Œç‚¹å‡»å®ƒ push åˆ° CPNowPlayingTemplateã€‚

**2. CarPlay ä¸»ç•Œé¢çš„ â€œæ’­æ”¾ä¸­ï¼ˆNow Playingï¼‰â€ app æ˜¯ä»€ä¹ˆï¼Ÿ**

* CPNowPlayingTemplate æ˜¯ä¸ªå•ä¾‹ç±»ï¼Œæ‰€æœ‰ CarPlay app çš„ â€œæ­£åœ¨æ’­æ”¾â€ ç•Œé¢éƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªå•ä¾‹ã€‚
* â€œæ’­æ”¾ä¸­â€ app å°†ä» nowPlayingCenter ä¸­å–æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥ app å°†æ˜¾ç¤º iPhone ä¸Šæ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ä¿¡æ¯ï¼Œå¹¶å°†éŸ³é¢‘æº app çš„ appName æ˜¾ç¤ºåœ¨å³ä¸Šè§’ï¼Œå³ä½¿è¯¥éŸ³é¢‘æº app ä¸æ”¯æŒ CarPlayã€‚å› æ­¤ï¼Œå³ä½¿ä½ çš„ app æš‚æ—¶ä¸æ”¯æŒ CarPlayï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡é€‚é…å¥½ MPNowPlayingInfoCenter å’Œ MPRemoteCommandCenter æ¥ä½¿ä½ çš„ app æ”¯æŒ CarPlay â€æ’­æ”¾ä¸­â€œ appã€‚

![](/Users/chenjunteng/Library/Application Support/typora-user-images/image-20211115092835324.png)

* å¦‚æœ â€œæ’­æ”¾ä¸­â€ app çš„éŸ³é¢‘æº app æ”¯æŒ CarPlayï¼Œé‚£ä¹ˆå¯åŠ¨ â€œæ’­æ”¾ä¸­â€ app å°±ä¼šè§¦å‘éŸ³é¢‘æº app çš„ CarPlay åœºæ™¯è¿æ¥ï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨éŸ³é¢‘æº CarPlay appã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Apple è®©æˆ‘ä»¬åœ¨ `- templateApplicationScene:didConnectInterfaceController:` çš„æ—¶æœºå°±é…ç½®å¥½ CPNowPlayingTemplate çš„åŸå› ï¼Œè€Œä¸åº”è¯¥åœ¨ push åˆ° CPNowPlayingTemplate çš„æ—¶å€™å»é…ç½®ï¼Œå› ä¸º CPNowPlayingTemplate å¹¶ä¸ä¸€å®šé€šè¿‡ä¸»åŠ¨ push æ—¶è§¦å‘ï¼Œå¯èƒ½æ˜¯é€šè¿‡ â€œæ’­æ”¾ä¸­â€ app æˆ–è€… rootTemplate å³ä¸Šè§’çš„ â€œæ­£åœ¨æ’­æ”¾æŒ‰é’®â€ã€‚ç‚¹å‡» â€œæ’­æ”¾ä¸­â€ app å·¦ä¸Šè§’çš„è¿”å›æŒ‰é’®ï¼Œå°†è¿”å›åˆ°è¯¥éŸ³é¢‘æºçš„ CarPlay app çš„ rootTemplateã€‚

**3. æ­£åœ¨æ’­æ”¾é¡µé¢ä¸­éŸ³é¢‘æ’å›¾ï¼ˆå°é¢ï¼‰ä¸æ˜¾ç¤º**

* å¦‚æœæ˜¯æ˜¾ç¤ºäº†å ä½å›¾ï¼Œé‚£å¯èƒ½æ˜¯å› ä¸ºä½ æ²¡å°†æœ‰æ•ˆå›¾ç‰‡è®¾ç½®åˆ° nowPlayingInfo çš„ MPMediaItemPropertyArtwork key ä¸­ã€‚
* å¦‚æœæ˜¯è¿å ä½å›¾éƒ½æ²¡æœ‰ï¼š
  * å¦‚æœæ˜¯çœŸå®ç¯å¢ƒæ±½è½¦ä¸­ä¸æ˜¾ç¤ºï¼Œéœ€è¦åœ¨ CarPlay è®¾ç½®ä¸­å°† `æ˜¾ç¤ºä¸“è¾‘æ’å›¾` æ‰“å¼€ã€‚å¦‚æœè®¾ç½®ä¸­æ²¡æœ‰æ˜¾ç¤ºè¯¥é€‰é¡¹ï¼Œé‚£å¯èƒ½æ˜¯å½“å‰ iPhone è®¾ç½®çš„è¯­è¨€å’Œåœ°åŒºä¸æ”¯æŒï¼Œåœ¨ iPhone çš„  `è®¾ç½® > è¯­è¨€å’Œåœ°åŒº` ä¸­è®¾ç½®ã€‚å‚è€ƒå¸–å­ https://tieba.baidu.com/p/6276976841ã€‚
  * å¦‚æœæ˜¯ CarPlay Simulatorï¼Œé‚£åº”è¯¥æ²¡åŠæ³•æ˜¾ç¤ºï¼Œå³ä½¿æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ“ä½œäº†ï¼Œè¿™ç‚¹æˆ‘æš‚æ—¶æ²¡æœ‰ä¾æ®ã€‚





